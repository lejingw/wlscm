#set($cssfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.css"])

#set($jsfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.js",
	"$StringUtil.getContextPath()/js/move/moveBill.js?t=201208061307.js",
	"$StringUtil.getContextPath()/dwr/interface/DictDwr.js",
	"$StringUtil.getContextPath()/dwr/interface/MoveNetDwr.js",
	"$StringUtil.getContextPath()/dwr/interface/MoveBillDwr.js?t=201208061433.js",
	"$StringUtil.getContextPath()/script/mclon/ZeroClipboard/ZeroClipboard.js"])

#if("1" == $!{form.billType})
	#set($modelCode = '0803010102')
#elseif("2" == $!{form.billType})
	#set($modelCode = '0803010202')
#elseif("3" == $!{form.billType})
	#set($modelCode = '0803010302')
#elseif("4" == $!{form.billType})
	#if("1" == "$!{form.jmFlag}")
		#set($modelCode = '09060402')
	#else
		#set($modelCode = '0803010402')
	#end
#elseif("5" == $!{form.billType})
	#if("1" == "$!{form.jmFlag}")
		#set($modelCode = '09060502')
	#else
		#set($modelCode = '0803010502')
	#end
#end
<div id="printDiv">
    <form id="print" method="post" target="_blank"  action="$StringUtil.getContextPath()/velocity/mclon/common/printLabelJson.jsp">
    	<input type="hidden" id="printData" name="LIST_FOR_BARCODE_JSON"/>
    	<input type="hidden" id="printPt" name="pt"/>
    	<input type="hidden" id="printParams" name="params"/>
    </form>
</div>
<form id='frm' action="" method="post">
	<input type='hidden' id='billType' value='$!{form.billType}'/>
	<input type='hidden' id='jmFlag' value='$!{form.jmFlag}'/>
	<input type='hidden' id='headid' value='$!{form.head.headid}'/>
    <table class="title">
    	<tr><td>$!DictUtil.getValue("movebilltype", $!form.billType)</td></tr>
    </table>
    <table class="control">
    	<tr>
			<td>
				<input type='button' value='保存' class='btn' id='btnSave' $RightUtil.able($session, $modelCode,'1')>
				<input type='button' value='审核' class='btn' id='btnMark' $RightUtil.able($session, $modelCode,'2')>
				#if("4" == "$!{form.billType}" || "5" == "$!{form.billType}")##移库单、柜组调拨单、
				<input type='button' value='接收' class='btn' id='btnReceive' $RightUtil.able($session, $modelCode,'5')>
				#end
				#if("1" == $!{form.billType}||"2" == $!{form.billType}||"3" == $!{form.billType})
    				#if("" != "$!{form.head.headid}")
    				<input type='button' value='打印' class='btn' id="btnPrint" $RightUtil.able($session, $modelCode,'3')>
    				<input type='button' value='打印标签' class='btn' id="btnPrintLabel" #if("" == "$!{form.printLabelType}") disabled #end $RightUtil.able($session, $modelCode,'4')>
    				<select id="printLabelType" name="printLabelType" onchange="changePrintLabelType()"><option value=''>-请选择-</option><option value='1'>普通标签</option><option value='2'>物流标签</option><option value='3'>价格标签</option></select>
    				#end
				#end
				<input type='button' value='返回列表' class='btn' id="btnToList">
			</td>
		</tr>
    </table>
    <table class='content'>
    	<tr>
			<td class='body1'>单据编号</td><td class='body2'><input type='text' readonly id='billno' value='自动生成'/></td>
			<td class='body1'>单据状态</td><td class='body2'><input type='text' readonly id='status' value='保存'/></td>
			<td class='body1'>调拨日期</td><td class='body2'><input type='text' readonly id='dodate' value='$!{DateUtil.getCurrentDate10()}'/></td>
			<td class='body1'>创建人</td><td class='body2'><input type='text' readonly id='createId' value='$!{StringUtil.getUserName($session)}'/></td>
		</tr>
		#if("1" == $!{form.billType})##调拨单
    	<tr>
			<td class='body1'>调出组织</td><td class='body2'>
				<input type='hidden' id='outGroup' value="">
				<input type='hidden' id='inGroup' value="">
				<input type='hidden' id='outOrgId' value="$!StringUtil.getOrgId($session)">
				<input type='text' id='outOrgName' value="$!StringUtil.getOrgName($session)" readonly>
			</td>
			<td class='body1'>调出仓库</td><td class='body2'>
				<input type='hidden' id='outStockId' value="1">
				<input type='text' id='outStockName' value="饰品库" readonly>
			</td>
			<td class='body1'>调入组织</td><td class='body2'>
				<input type='hidden' id='inOrgId'>
				<input type='text' id='inOrgName' readonly class='target' ondblclick="showInOrgWin()">
			</td>
			<td class='body1'>调入仓库</td><td class='body2'>
				<input type='hidden' id='inStockId' value="1">
				<input type='text' id='inStockName' value="饰品库" readonly>
			</td>
		</tr>
		#elseif("2" == $!{form.billType})##退货单
    	<tr>
			<td class='body1'>调出组织</td><td class='body2'>
				<input type='hidden' id='outGroup' value="">
				<input type='hidden' id='inGroup' value="">
				<input type='hidden' id='outOrgId' value="$!StringUtil.getOrgId($session)">
				<input type='text' id='outOrgName' value="$!StringUtil.getOrgName($session)" readonly>
			</td>
			<td class='body1'>调出仓库</td><td class='body2'>
				<input type='hidden' id='outStockId' value="1">
				<input type='text' id='outStockName' value="饰品库" readonly>
			</td>
			<td class='body1'>调入总部组织</td><td class='body2'>
				<select id='inOrgId'></select>
			</td>
			<td class='body1'>调入仓库</td><td class='body2'>
				<input type='hidden' id='inStockId' value="2">
				<input type='text' id='inStockName' value="旧品库" readonly>
			</td>
		</tr>
		#elseif("3" == $!{form.billType})##退残单
		<tr>
			<td class='body1'>调出组织</td><td class='body2'>
				<input type='hidden' id='outGroup' value="">
				<input type='hidden' id='inGroup' value="">
				<input type='hidden' id='outOrgId' value="$!StringUtil.getOrgId($session)">
				<input type='text' id='outOrgName' value="$!StringUtil.getOrgName($session)" readonly>
			</td>
			<td class='body1'>调出仓库</td><td class='body2'>
				<input type='hidden' id='outStockId' value="2">
				<input type='text' id='outStockName' value="旧品库" readonly>
			</td>
			<td class='body1'>调入总部组织</td><td class='body2'>
				<select id='inOrgId'></select>
			</td>
			<td class='body1'>调入仓库</td><td class='body2'>
				<input type='hidden' id='inStockId' value="2">
				<input type='text' id='inStockName' value="旧品库" readonly>
			</td>
		</tr>
		#elseif("4" == $!{form.billType})##移库单
		<tr>
			<td class='body1'>组织</td><td class='body2'>
				<input type='hidden' id='inOrgId'  value="$!StringUtil.getOrgId($session)">
				<input type='hidden' id='outGroup' value="">
				<input type='hidden' id='inGroup' value="">
				<input type='hidden' id='outOrgId' value="$!StringUtil.getOrgId($session)">
				<input type='text' id='outOrgName' value="$!StringUtil.getOrgName($session)" readonly>
			</td>
			<td class='body1'>调出仓库</td><td class='body2'>
				<select id='outStockId' dataType="Require" msg="不能为空" onchange="changeStock(this)"></select>
			</td>
			<td class='body1'>调入仓库</td><td class='body2'>
				<select id='inStockId' dataType="Require" msg="不能为空" onchange="changeStock(this)"></select>
			</td>
		</tr>
		#elseif("5" == $!{form.billType})##柜组调拨单
		<tr>
			<td class='body1'>组织</td><td class='body2'>
				<input type='hidden' id='inOrgId'  value="">
				<input type='hidden' id='outStockId' value="">
				<input type='hidden' id='inStockId' value="">
				<input type='hidden' id='outOrgId' value="$!StringUtil.getOrgId($session)">
				<input type='text' id='outOrgName' value="$!StringUtil.getOrgName($session)" readonly>
			</td>
			<td class='body1'>调出柜组</td><td class='body2'>
				<select id='outGroup' dataType="Require" msg="不能为空" onchange="changeGroup(this)"></select>
			</td>
			<td class='body1'>调入柜组</td><td class='body2'>
				<select id='inGroup' dataType="Require" msg="不能为空" onchange="changeGroup(this)"></select>
			</td>
		</tr>
		#end
    	<tr>
			<td class='body1'>件数合计</td><td class='body2'><input type='text' readonly id='sumCount' value='$!{form.head.sumCount}'/></td>
			<td class='body1'>重量合计</td><td class='body2'><input type='text' readonly id='sumWeight' value='$!{form.head.sumWeight}'/></td>
			<td class='body1'>粒数合计</td><td class='body2'><input type='text' readonly id='sumGrains' value='$!{form.head.sumGrains}'/></td>
		#if("1" == $!{form.billType} || "2" == $!{form.billType} || "3" == $!{form.billType})
			#if($RightUtil.isAble($session, $modelCode,'5'))
			<td class='body1'>成本合计</td><td class='body2'><input type='hidden' id='sumMoney' value='$!{form.head.sumMoney}'/>
				<input type='text' readonly id='sumCost' value='$!{form.head.sumCost}'/></td>
    		#else
			<td class='body1'></td><td class='body2'>
				<input type='hidden' id='sumMoney' value='$!{form.head.sumMoney}'/>
				<input type='hidden' id='sumCost' value='$!{form.head.sumCost}'/>
			</td>
			#end
		#else
			#if($RightUtil.isAble($session, $modelCode,'6'))
				<td class='body1'>成本合计</td><td class='body2'><input type='hidden' id='sumMoney' value='$!{form.head.sumMoney}'/>
				<input type='text' readonly id='sumCost' value='$!{form.head.sumCost}'/></td>
    		#else
			<td class='body1'></td><td class='body2'>
				<input type='hidden' id='sumMoney' value='$!{form.head.sumMoney}'/>
				<input type='hidden' id='sumCost' value='$!{form.head.sumCost}'/>
			</td>
			#end
		#end
		</tr>
    	<tr>
			<td class='body1'>接收日期</td><td class='body2'><input type='text' readonly id='receiveDate' value='$!{form.head.receiveDate}'/></td>
			<td class='body1'>接收人员</td><td class='body2'><input type='text' readonly id='receiveEmpId' value='$!BdCommon.getUserName($!{form.head.receiveEmpId})'/></td>
			<td class='body1'>接收件数</td><td class='body2'><input type='text' readonly id='receCount' value='$!{form.head.receCount}'/></td>
			<td class='body1'>作废件数</td><td class='body2'><input type='text' readonly id='discardCount' value='$!{form.head.discardCount}'/></td>
		</tr>
    	<tr>
			<td class='body1'>饰品条码</td><td class='body2'><input type='text' id='barCode_in' value=''/></td>
			<td class='body1'>饰品编码</td><td class='body2'><input type='text' id='ornaCode_in' value=''/></td>
		#if("2" == $!{form.billType})##
			<td class='body1'>48小时退货</td><td class='body2'><input type='checkbox' id='backIn48Flag'  #if("1" == "$!{form.head.backIn48Flag}") checked #end></td>
			<td class='body1'>备注</td><td class='body2'><input type='text' id='memo' value='$!{form.head.memo}'/></td>
		#elseif("1" == $!{form.billType})
			#if($RightUtil.isAble($session, $modelCode,'6'))
			<td class='body1'>新总成本</td><td class='body2'><input type='text' id='sumNewPosCost' readonly value='$!{form.head.sumNewPosCost}'/></td>
			#else
			<td class='body1'></td><td class='body2'><input type='hidden' id='sumNewPosCost' value='$!{form.head.sumNewPosCost}'/></td>
			#end
			<td class='body1'>备注</td><td class='body2'><input type='text' id='memo' value='$!{form.head.memo}'/></td>
		#else
			<td class='body1'>备注</td><td class='body2' colspan="3"><input type='text' id='memo' value='$!{form.head.memo}' style="width:95%;"/></td>
		#end
		</tr>
		#if("1" == $!{form.billType})
			#set($moveCmdId = "")
			#set($moveCmdNo = "")
			#if("$!form.head.srcBillCode" == "MC")
				#set($moveCmdId = $!form.head.srcBillId)
				#set($moveCmdNo = $!form.head.srcBillNo)
			#end
		<tr>
			<td class='body1'>调拨指令单</td>
			<td class='body2'>
				<input type='hidden' id='oldMoveCmdId' value='$!moveCmdId'/>
				<input type='hidden' id='moveCmdId' value='$!moveCmdId'/>
				<input type='text' id='moveCmdNo' value='$!moveCmdNo' class="target" ondblclick="showSelectMoveCmdWin()"/>
			</td>
			<td class='body1'></td><td class='body2'></td><td class='body1'></td><td class='body2'></td><td class='body1'></td><td class='body2'></td>
		</tr>
		#end
    </table>
	<table class='list'>
		<thead>
			<tr>
				<th></th>
				<th><input type='checkbox' id='chkall'/></th>
				<th>双标签</th>
				<th>需要打印</th>
				<th>饰品编码</th>
				<th>饰品名称</th>
				<th>大类</th>
				<th>小类</th>
				<th>分析范围</th>
				<th>款式</th>
				<th>计量单位</th>
				<th>总重量</th>
				<th>现有量</th>
				<th>粒数</th>
				<th>网点金额</th>
				<th>主石重</th>
				<th>配石重</th>
				<th>状态</th>
				<th width='60px;'></th>
			</tr>
		</thead>
		<tbody id='tbl'>
		#foreach($item in $form.lineList)
			<tr><td></td>
				<td>
					<input type='checkbox' name='chk'/>
            		<input type='hidden' name='lineid' value='$!{item.lineid}'/>
            		<input type='hidden' name='ornaCode' value='$!{item.ornaCode}'/>
            		<input type='hidden' name='barCode' value='$!{item.barCode}'/>
            		<input type='hidden' name='allWeight' value='$!{item.allWeight}'/>
            		<input type='hidden' name='posCost' value='$!{item.posCost}'/>
            		<input type='hidden' name='posAmount' value='$!{item.posAmount}'/>
            		<input type='hidden' name='newPosCost' value='$!{item.newPosCost}'/>
            		<input type='hidden' name='grains' value='$!{item.grains}'/>
				</td>
				<td>$!DictUtil.getValue('yesorno', $item.isDblLabel)</td>
				<td>$!DictUtil.getValue('yesorno', $item.printLabel)</td>
				<td>$!item.ornaCode</td>
				<td>$!item.ornaDsc</td>
				<td>$!BdCommon.getItemClassDesc($!item.itemClassId)</td>
				<td>$!BdCommon.getOrnaClassDesc($!item.ornaClassId)</td>
				<td>$!item.analysisName</td>
				<td>$!HtmlUtil.printStyle($!item.styleId, $!item.styleName, $!item.bigGraph)</td>
				<td>$!BdCommon.getUnitName($!item.unitId)</td>
				<td>$!item.allWeight</td>
				<td>$!item.nowQty</td>
				<td>$!item.grains</td>
				<td>$!item.newPosMoney</td>
				<td>$!item.mainWeight</td>
				<td>$!item.partWeight</td>
				<td>$!DictUtil.getValue('status', $!item.status)</td>
				<td><input type='button' class='btn' name="deleteBtn" value='删除' onclick='deleteMoveRow(this)'/></td>
			</tr>
		#end
        </tbody>
    </table>
</form>
<script>
function changeStock(obj){
	if(!isNull(obj.value)){
    	if(jQuery("#inStockId").val() == jQuery("#outStockId").val()){
			alert("调入、调出仓库不能相同");
    		obj.value = "";
    	}
	}
}
function changeGroup(obj){
	if(!isNull(obj.value)){
    	if(jQuery("#outGroup").val() == jQuery("#inGroup").val()){
			alert("调入、调出柜组不能相同");
    		obj.value = "";
    	}
	}
}
function checkForm(){
	if(!Validator.Validate($("frm"),3))
		return false;
	if("1" == jQuery("#billType").val() || "2" == jQuery("#billType").val() || "3" == jQuery("#billType").val()){//调拨单、退货单、退残单
    	if(jQuery("#outOrgId").val() == jQuery("#inOrgId").val()){
    		alert("调入组织不能和调出组织相同");
    		return false;
    	}
	}else if("4" == jQuery("#billType").val()){//移库单
    	if(jQuery("#outStockId").val() == jQuery("#inStockId").val()){
    		alert("调入仓库不能和调出仓库相同");
    		return false;
    	}
	}else if("5" == jQuery("#billType").val()){//柜组调拨单
    	if(jQuery("#outGroup").val() == jQuery("#inGroup").val()){
    		alert("调入柜组不能和调出柜组相同");
    		return false;
    	}
	}
	if($n("ornaCode").length<1){
		alert("请添加调拨饰品");
		return false;
	}
	return true;
}
function saveform(status){
	if(!checkForm())	return;
	var action = "1" == status?"保存":("4" == status?"审核":"");
	confirm("确定"+action+"?", function(){
		var moveHead = {
			headid : jQuery("#headid").val(),
			billType : jQuery("#billType").val(),
			jmFlag : jQuery("#jmFlag").val(),
			billno : jQuery("#billno").val(),
			outOrgId : jQuery("#outOrgId").val(),
			outStockId : jQuery("#outStockId").val(),
			inOrgId : jQuery("#inOrgId").val(),
			inStockId : jQuery("#inStockId").val(),
			outGroup : jQuery("#outGroup").val(),
			inGroup : jQuery("#inGroup").val(),
			dodate : jQuery("#dodate").val(),
			memo : jQuery("#memo").val(),
			backIn48Flag : jQuery("#backIn48Flag").attr("checked")?"1":"0",
			status : status,
			srcBillId:jQuery("#moveCmdId").val(),
			srcBillNo:jQuery("#moveCmdNo").val(),
			srcBillCode:jQuery("#moveCmdId").val()?'MC':'',
			oldSrcBillId:jQuery("#oldMoveCmdId").val()
		};
		//info(moveHead);
		//return ;
		var newOrnaCodeArr = [];
		for(var i=0;i<$n("ornaCode").length;i++){
			//lineid为空表示新添加
			if(isNull($n("lineid")[i].value)){
    			newOrnaCodeArr.push($n("ornaCode")[i].value);
			}
		}
		if(jQuery("#moveCmdId").val() && jQuery("#moveCmdId").val().length > 0){
			saveMoveBill(moveHead, newOrnaCodeArr, deleteOrnaCodeArr, action);
		} else {
    		showLayer(true);
    		MoveBillDwr.checkOrnaStatusAvail(newOrnaCodeArr, function(data){
        		showLayer(false);
    			if(data){
    				alert("饰品编码：<br>"+data.join("<br>")+"<br>状态不为有效，不能进行调拨");
    				return ;
    			}
        		saveMoveBill(moveHead, newOrnaCodeArr, deleteOrnaCodeArr, action);
    		});
		}
	});
}

function saveMoveBill(moveHead, newOrnaCodeArr, deleteOrnaCodeArr, action){
	var sumCost = 0;
	//饰品调拨单如果行记录多余1条，则要控制总成本
	if(("1" == jQuery("#billType").val() || "2" == jQuery("#billType").val() || "3" == jQuery("#billType").val()) && $n("ornaCode").length>1){
		sumCost = jQuery("#sumCost").val();
	}
	showLayer(true);
    MoveBillDwr.saveMoveBill(moveHead, newOrnaCodeArr, deleteOrnaCodeArr, sumCost, function(data2){
		showLayer(false);
    	alert(data2?data2:action+"成功", function(){
			if(!data2){
        		window.location = "moveBill.vm?billType=$!{form.billType}&jmFlag=$!{form.jmFlag}";
			}
    	});
    });
}
/**
 * 移库单或柜组调拨单接收
 */
function receiveMoveBill(){
	confirm("确定接收?", function(){
		MoveBillDwr.receiveMoveBill(jQuery("#headid").val(), function(data){
			alert(data?data:"接收成功", function(){
				if(!data){
    				window.location = "moveBill.vm?billType=$!{form.billType}&jmFlag=$!{form.jmFlag}";
				}
			});
		});
	});
}
//修改时删除的行id
var deleteOrnaCodeArr = [];
jQuery(function(){
	checkTable('tbl', 'chkall', 'chk', true);
	jQuery("#btnSave").click(function(){saveform("1");});
	/*
	jQuery("#btnSave").click(function(){
		alert('-----');
		confirm("确定？", function(){
			showLayer(true);
			MoveBillDwr.test(function(data){
				showLayer(false);
				info('--------------')
			});
		});
	});
	*/
	//setEnterKey("ornaCode_in", function(){MoveBillDwr.test();});
	jQuery("#btnMark").click(function(){saveform("4");});
	jQuery("#btnPrint").click(printMoveBill);
	//jQuery("#btnPrintLabel").click(printOrnaLabel);
	#if("1" == $!{form.billType}||"2" == $!{form.billType}||"3" == $!{form.billType})
    	#if("" != "$!{form.head.headid}")
			initLabelPrint("btnPrintLabel", printOrnaLabel);
    	#end
	#end
	#if("4" == "$!{form.billType}" ||"5" == "$!{form.billType}")
		jQuery("#btnReceive").click(receiveMoveBill);
	#end
	//返回列表
	jQuery("#btnToList").click(function(){
		forward("moveBill.vm?billType=$!{form.billType}&jmFlag=$!{form.jmFlag}");
	});
	setEnterKey('ornaCode_in', getMaterActiveByOrnaCode);
	setEnterKey('barCode_in', getMaterActiveByBarCode);
	setContent();
	setValues();
	changeButtons();
	initMoveCmdData();
});
function setValues(){
	if(isNull(jQuery("#headid").val()))	return ;
	jQuery("#billno").val("$!{form.head.billno}");
	jQuery("#status").val("$!DictUtil.getValue('status', $!{form.head.status})");
	jQuery("#dodate").val("$!{form.head.dodate}");
	jQuery("#createId").val("$!BdCommon.getUserName($!{form.head.createId})");
	
	#if("1" == $!{form.billType} || "2" == $!{form.billType} || "3" == $!{form.billType})##调拨单、退货单、退残单
    	jQuery("#outOrgId").val("$!{form.head.outOrgId}");
    	jQuery("#outOrgName").val("$!BdCommon.getOrgName($!{form.head.outOrgId})");
		#if("1" == $!{form.billType})
    		//removeAllOptions("inOrgId",false);
    		//addOption("inOrgId", "$!{form.head.inOrgId}", "$!BdCommon.getOrgName($form.head.inOrgId)");
        	jQuery("#inOrgId").val("$!{form.head.inOrgId}");
        	jQuery("#inOrgName").val("$!BdCommon.getOrgName($!{form.head.inOrgId})");
    		jQuery("#inOrgName").attr("disabled", true);
		#end
		
		jQuery("#outStockId").val("$!{form.head.outStockId}");
		jQuery("#outStockName").val("$!DictUtil.getValue('invcode', $!{form.head.outStockId})");
		jQuery("#inStockId").val("$!{form.head.inStockId}");
		jQuery("#inStockName").val("$!DictUtil.getValue('invcode', $!{form.head.inStockId})");
		
		jQuery("#inOrgId").attr("disabled", true);
		jQuery("#backIn48Flag").attr("disabled", true);
		selectOption("printLabelType", "$!form.printLabelType");
	#elseif("4" == $!{form.billType})##移库单
    	jQuery("#outOrgId").val("$!{form.head.outOrgId}");
    	jQuery("#outOrgName").val("$!BdCommon.getOrgName($!{form.head.outOrgId})");
		
		jQuery("#inOrgId").val("$!{form.head.inOrgId}");
		
		selectOption("outStockId", "$!{form.head.outStockId}");
		selectOption("inStockId", "$!{form.head.inStockId}");
		
		jQuery("#outStockId").attr("disabled", true);
		jQuery("#inStockId").attr("disabled", true);
	#elseif("5" == $!{form.billType})##柜组调拨单
    	jQuery("#outOrgId").val("$!{form.head.outOrgId}");
    	jQuery("#outOrgName").val("$!BdCommon.getOrgName($!{form.head.outOrgId})");
		
		jQuery("#inOrgId").val("$!{form.head.inOrgId}");
		
		selectOption("outGroup", "$!{form.head.outGroup}");
		selectOption("inGroup", "$!{form.head.inGroup}");
		
		jQuery("#outGroup").attr("disabled", true);
		jQuery("#inGroup").attr("disabled", true);
	#end
	
	checkReview();
	calcSum();
}
function showInOrgWin(){
	selectOrg(function(idArr, nameArr){
		jQuery("#inOrgId").val(idArr.join(','));
		jQuery("#inOrgName").val(nameArr.join(','));
	}, null, null, false, jQuery("#inOrgId").val(), "getInOrgByMoveNet");
}
function setContent(){
	initCalendar('dodate');
	if("1" == "$!{form.billType}"){
		if(isNull(jQuery("#headid").val())){
    		/*
        	MoveNetDwr.getInOrgByMoveNet(function(data){
        		addOptions("inOrgId", data, null, null, true, true);
        	});
    		*/
		}
	}else if("2" == "$!{form.billType}" || "3" == "$!{form.billType}"){
		DictDwr.getDictsForSlt('hqorgs', function(data){
    		addOptions("inOrgId", data, null, null, true, true, "$!{form.head.inOrgId}");
		});
	}else if("4" == "$!{form.billType}"){//移库单
    	DictDwr.getDictsForSlt("invcode", function(data){
    		addOptions("outStockId", data, null, null, true, true, "$!{form.head.outStockId}");
    		addOptions("inStockId", data, null, null, true, true, "$!{form.head.inStockId}");
    	});
	}else if("5" == "$!{form.billType}"){//柜组调拨单
    	DictDwr.getDictsForSlt("group", function(data){
    		addOptions("outGroup", data, null, null, true, true, "$!{form.head.outGroup}");
    		addOptions("inGroup", data, null, null, true, true, "$!{form.head.inGroup}");
    	});
	}
}
function changeButtons(){
	jQuery("#btnSave").attr("disabled", true);
	jQuery("#btnMark").attr("disabled", true);
	
	if(("1" == "$!{form.head.status}" || isNull("$!{form.head.status}")) && ("$!StringUtil.getOrgId($session)" == jQuery("#outOrgId").val())){
    	jQuery("#btnSave").attr("disabled", false);
    	jQuery("#btnMark").attr("disabled", false);
	}
	
	#if("4" == "$!{form.billType}" ||"5" == "$!{form.billType}")
       	jQuery("#btnReceive").attr("disabled", true);
    	if("5" == "$!{form.head.status}"){//审批完成
        	jQuery("#btnReceive").attr("disabled", false);
    	}
	#end
}
/**
 * 打印单据
 */
function printMoveBill(){
	var options = {
		title : '打印调拨单',
		contentType : 'iframe',
		iframeId : "billFrm",
		width : 800,
		height : 350,
		okBtnName : '确定',
		//cancelBtnName : '取消',
		showCancelBtn : false
	};
	var url = ctxPath + '/move/moveBill.vm?user_action=printbill&headid=' + jQuery("#headid").val();
	jQuery.weeboxs.open(url, options);
}
function changePrintLabelType(){
	var url = "moveBill.vm?user_action=toEdit&headid=" + jQuery("#headid").val() + "&printLabelType=" + jQuery("#printLabelType").val();
	jQuery("#frm").attr("action", url);
	jQuery("#frm").submit();
}
/**
 * 打印标签
 */
function printOrnaLabel(){
	var indexs = getSelectIndexs('chk');
	if(indexs.length==0){
		alert("请选择要打印的记录");
		return ;
	}
	var ornaCodeArr = [] ;
	for(var i=0; i<indexs.length; i++){
		ornaCodeArr.push($n("ornaCode")[indexs[i]].value);
	}
	var url = ctxPath + '/move/moveBill.vm?user_action=printLabel&headid=' + jQuery("#headid").val()
		+ "&printLabelType=" + jQuery("#printLabelType").val()
		+ "&ornaCodes=" +　ornaCodeArr.join(",");
	return url;
}
</script>