#set($jsfiles = ["$!StringUtil.getContextPath()/dwr/interface/DispatchWayDwr.js",
"$StringUtil.getContextPath()/script/mclon/ajaxfileupload.js"])
#set($modelCode='08031201')
#set($queryCode='12')
<form id="frm" action="dispatchWay.vm" method="post">
    <input type='hidden' id='user_action' name='user_action' value='styleList'/>
    <table class="control">
    	<tr>
			<td>
				<input type='button' value='添加' class='btn' onclick="addBill()" $RightUtil.able($session, $modelCode,'1')>
				<input type='button' value='修改' class='btn' onclick="editBill()" id='btnEdit' $RightUtil.able($session, $modelCode,'2')>
				<input type='button' value='删除' class='btn' onclick="deleteBill()" id="btnDelete" $RightUtil.able($session, $modelCode,'3')>
				<input type='button' value='复制' class='btn' onclick="copyBill()" id="btnCopy" $RightUtil.able($session, $modelCode,'4')>
				<input type='button' value='导入Excel' class='btn' id='' onclick="showImportWin()" $RightUtil.able($session, $modelCode,'5')>
				<input type='button' value='导出Excel' class='btn' id='exportToExcel' onclick="exportListToExcel()" $RightUtil.able($session, $modelCode,'6')>
				<input type='button' value='查询' class='btn' id="btnQueryShow" $RightUtil.able($session, $modelCode,'7')>
			</td>
		</tr>
    </table>
	<div class="scroll">
    <table class='list' style='width:1800px;'>
    	<thead>
			<tr>
                <th width='45px'><input type='checkbox' id='chkall'/></th>
        		<th width='80px'>状态</th>
                <th width='180px'>组织</th>
                <th width='120px'>大类</th>
                <th width='120px'>小类</th>
                <th width='120px'>分析范围</th>
                <th width='120px'>款式大类</th>
                <th width='120px'>款式中类</th>
                <th width='120px'>款式小类</th>
                <th width='120px'>款式</th>
                <th width='120px'>铺货量最小值</th>
                <th width='120px'>铺货量最大值</th>
        		<th width='120px'>创建时间</th>
        		<th width='90px'>创建人</th>
        		<th width='120px'>修改时间</th>
        		<th width='90px'>修改人</th>
            </tr>
        </thead>
        <tbody id="tbl">
		#foreach($item in $form.pager.pageData)
			<tr>
				<td><input type='checkbox' name='chk' value='$!{item.billId}'/>
						<input type='hidden' name='hd_orgId' value='$!item.orgId'/>
						<input type='hidden' name='hd_orgName' value='$!BdCommon.getOrgName($!item.orgId)'/>
						<input type='hidden' name='hd_itemClassId' value='$!item.itemClassId'/>
						<input type='hidden' name='hd_ornaClassId' value='$!item.ornaClassId'/>
						<input type='hidden' name='hd_analysisId' value='$!item.analysisId'/>
						<input type='hidden' name='hd_styleItemClassId' value='$!item.styleItemClassId'/>
						<input type='hidden' name='hd_styleMiddleClassId' value='$!item.styleMiddleClassId'/>
						<input type='hidden' name='hd_styleOrnaClassId' value='$!item.styleOrnaClassId'/>
						<input type='hidden' name='hd_styleId' value='$!item.styleId'/>
						<input type='hidden' name='hd_dispMin' value='$!item.dispMin'/>
						<input type='hidden' name='hd_dispMax' value='$!item.dispMax'/>
					$velocityCounter
				</td>
				<td>$!DictUtil.getValue('status', $!item.status)</td>
				<td><a href='javascript:showEidtDialog($velocityCounter - 1);'>$!BdCommon.getOrgName($!item.orgId)</a></td>
				<td>$!BdCommon.getItemClassDesc($!item.itemClassId)</td>
				<td>$!BdCommon.getOrnaClassDesc($!item.ornaClassId)</td>
				<td>$!item.analysisName</td>
    			<td>$!BdCommon.getStyleItemClassNames($!item.styleItemClassId)</td>
    			<td>$!BdCommon.getStyleMiddleClassNames($!item.styleMiddleClassId)</td>
    			<td>$!BdCommon.getStyleOrnaClassNames($!item.styleOrnaClassId)</td>
				<td>$!HtmlUtil.printStyle($!item.styleId, $!item.styleName, $!item.bigGraph)</td>
				<td>$!item.dispMin</td>
				<td>$!item.dispMax</td>
				<td>$!item.createDate</td>
				<td>$!BdCommon.getUserName($!item.createId)</td>
				<td>$!item.updateDate</td>
				<td>$!BdCommon.getUserName($!item.updateId)</td>
			</tr>
		#end
    	</tbody>
    </table>
	</div>
<script>
createPagingToolbar('frm', $!form.pager.start, $!form.pager.limit, $!form.pager.totalCount);
</script>
</form>
<div id='gradeDiv' style="display:none;">
	<form id='frm2'>
    	<input type='hidden' id='billId'>
        <table class="control">
        	<tr>
    			<td>
    				<input type='button' value='保存' onclick="saveDispatchStyle()" $RightUtil.able($session, '08031202','1')>
    				<input type='button' value='保存并复制' onclick="saveDispatchStyleAndCopy()" $RightUtil.able($session, '08031202','2')>
    				<input type='button' value='取消' onclick="jQuery('#gradeDiv').dialog('close');">
    			</td>
    		</tr>
        </table>
		<table class='content'>
			<tr>
                <td class='body1'>组织</td>
                <td class='body2'><input type='hidden' id='orgId'><input type='text' id='orgName' readonly class="target" ondblclick="showOrgWin()" dataType="Require" msg="不能为空"></td>
			</tr>
			<tr>
                <td class='body1'>大类</td>
                <td class='body2'><select id='itemClassId' onchange="changeOrnaClassId()" dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
                <td class='body1'>小类</td>
                <td class='body2'><select id='ornaClassId' onchange="changeOrnaClass()" dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
			</tr>
			<tr>
                <td class='body1'>分析范围</td>
                <td class='body2'><select id='analysisId' dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
                <td class='body1'>款式大类</td>
                <td class='body2'><select id='styleItemClassId' onchange="changeStyleItemClassId()" dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
			</tr>
			<tr>
                <td class='body1'>款式中类</td>
                <td class='body2'><select id='styleMiddleClassId' onchange="changeStyleMiddleClassId()" dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
                <td class='body1'>款式小类</td>
                <td class='body2'><select id='styleOrnaClassId' onchange="changeStyleOrnaClassId()" dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
			</tr>
			<tr>
                <td class='body1'>款式</td>
                <td class='body2'><select id='styleId' dataType="Require" msg="不能为空">$!StringUtil.emptyOption()</select></td>
			</tr>
			<tr>
                <td class='body1'>铺货量最小值</td>
                <td class='body2'><input type='text' id='dispMin' dataType="Money" msg="不能为空，且为金额类型"></td>
                <td class='body1'>铺货量最大值</td>
                <td class='body2'><input type='text' id='dispMax' dataType="Money" msg="不能为空，且为金额类型"></td>
			</tr>
        </table>
	</form>
</div>
<div id="importExcelDiv" style="display:none;">
	<form method="post">
        <table class="control">
        	<tr>
    			<td>
    				<input type='button' value='导入' onclick="ajaxFileUpload()" >
    			</td>
    		</tr>
    	</table>
    	<table class='content'>
        	<tr>
    			<td class='body1'>选择文件：</td>
    			<td class='body2'>
    				<input name="excel_file" type="file" id="excel_file" style="background:#eeeeee;font:normal 12px Tahoma;width:220px;"> 
    			</td>
    		</tr>
            <tr><td colspan="2">
    				<font style="color:red">
    					注：请严格按照模板来导入，若没有模板点击
    					<a href="/wlscm/velocity/mclon/move/template_dispatchWayStyle.xls">这里</a>
    					下载模板。
    		</td></tr>
        </table>
    </form>
</div>
<script>
function showOrgWin(){
	selectOrg(function(idArr, nameArr){
    		jQuery("#orgId").val(idArr.join(","));
    		jQuery("#orgName").val(nameArr.join(","));
	}, null, null, false, jQuery("#orgId").val());
}
/**
 * 改变大类
 */
function changeOrnaClassId(){
	BdCommonDwr.getOrnaClassByItemClassIdForSlt(jQuery("#itemClassId").val(), function(data){
		addOptions("ornaClassId", data, null, null, true, true);
		changeOrnaClass();
	});
}
/**
 *　改变小类
 */
function changeOrnaClass(){
	//获取分析范围
	BdCommonDwr.getAnalysisForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), function(data){
		addOptions("analysisId", data, null, null, true, true);
	});
	//获取款式大类
	BdCommonDwr.getStyleItemClassForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), function(data){
		addOptions("styleItemClassId", data, null, null, true, true);
		changeStyleItemClassId();
	});
}
/**
 *　改变款式大类
 */
function changeStyleItemClassId(){
	//获取款式中类
	BdCommonDwr.getStyleMiddleClassForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), jQuery("#styleItemClassId").val(), function(data){
		addOptions("styleMiddleClassId", data, null, null, true, true);
		changeStyleMiddleClassId();
	});
}
/**
 *　改变款式中类
 */
function changeStyleMiddleClassId(){
	//获取款式小类
	BdCommonDwr.getStyleOrnaClassForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), jQuery("#styleItemClassId").val(), jQuery("#styleMiddleClassId").val(), function(data){
		addOptions("styleOrnaClassId", data, null, null, true, true);
		changeStyleOrnaClassId();
	});
}
/**
 *　改变款式小类
 */
function changeStyleOrnaClassId(){
	//获取款式
	BdCommonDwr.getStyleForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), jQuery("#styleItemClassId").val(), jQuery("#styleMiddleClassId").val(), jQuery("#styleOrnaClassId").val(), function(data){
		addOptions("styleId", data, null, null, true, true);
	});
}
function addBill(){
	jQuery("#billId").val("");
	jQuery("#orgId").val("");
	jQuery("#orgName").val("");
	selectOption('itemClassId', "");
	selectOption('ornaClassId', "");
	selectOption('analysisId', "");
	selectOption("styleItemClassId", "");
	selectOption("styleMiddleClassId", "");
	selectOption("styleOrnaClassId", "");
	selectOption("styleId", "");
	jQuery("#dispMin").val("");
	jQuery("#dispMax").val("");
	showGradeWin();
}
var refreshFlag = false;
function showGradeWin(){
	jQuery("#gradeDiv").dialog({
			title:'款式配货数据设置',
			width:600, 
			height:300,
			modal:true,
			zIndex:1,
			close:function(){
				if(refreshFlag){
            		window.location = "dispatchWay.vm?user_action=styleList";
            	}else{
                	jQuery('#gradeDiv').dialog('close');
            	}
			}
		});
}
function showEidtDialog(index){
	jQuery("#billId").val($n("chk")[index].value);
	jQuery("#orgId").val($n("hd_orgId")[index].value);
	jQuery("#orgName").val($n("hd_orgName")[index].value);
	BdCommonDwr.getAllItemClassForSlt(function(data){
		addOptions("itemClassId", data, null, null, true, true, $n("hd_itemClassId")[index].value);
		BdCommonDwr.getOrnaClassByItemClassIdForSlt(jQuery("#itemClassId").val(), function(data2){
    		addOptions("ornaClassId", data2, null, null, true, true, $n("hd_ornaClassId")[index].value);
        	//获取分析范围
        	BdCommonDwr.getAnalysisForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), function(data3){
        		addOptions("analysisId", data3, null, null, true, true,  $n("hd_analysisId")[index].value);
			});
        	BdCommonDwr.getStyleItemClassForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), function(data){
        		addOptions("styleItemClassId", data, null, null, true, true, $n("hd_styleItemClassId")[index].value);
				BdCommonDwr.getStyleMiddleClassForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), jQuery("#styleItemClassId").val(), function(data){
            		addOptions("styleMiddleClassId", data, null, null, true, true, $n("hd_styleMiddleClassId")[index].value);
					BdCommonDwr.getStyleOrnaClassForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), jQuery("#styleItemClassId").val(), jQuery("#styleMiddleClassId").val(), function(data){
                		addOptions("styleOrnaClassId", data, null, null, true, true, $n("hd_styleOrnaClassId")[index].value);
						BdCommonDwr.getStyleForSlt(jQuery("#itemClassId").val(), jQuery("#ornaClassId").val(), jQuery("#styleItemClassId").val(), jQuery("#styleMiddleClassId").val(), jQuery("#styleOrnaClassId").val(), function(data){
                    		addOptions("styleId", data, null, null, true, true, $n("hd_styleId")[index].value);
                    	});
                	});
            	});
        	});
    	});
	});
	jQuery("#dispMin").val($n("hd_dispMin")[index].value);
	jQuery("#dispMax").val($n("hd_dispMax")[index].value);
	showGradeWin();
}
function editBill(){
	var idxs = getSelectIndexs('chk');
	if(idxs.length != 1){
		alert("请选择要修改的一条记录");
		return ;
	}
	showEidtDialog(idxs[0]);
}
function deleteBill(){
	var idxs = getSelectIndexs('chk');
	if(idxs.length<1){
		alert("请选择要删除的记录");
		return ;
	}
	confirm("确定删除?", function(){
		showLayer(true);
		var billIdArr = [];
		for(var i=0, j=idxs.length;i<j;i++){
			billIdArr.push($n("chk")[idxs[i]].value);
		}
    	DispatchWayDwr.deleteDispatchStyle(billIdArr, function(data){
    		showLayer(false);
    		alert(data?data:"删除成功", function(){
    			if(!data){
                	window.location = "dispatchWay.vm?user_action=styleList";
    			}
    		});
    	});
	});
}

function exportListToExcel(){
	jQuery("#user_action").val("exportExcelStyle");
	jQuery("#frm").submit();
	jQuery("#user_action").val("styleList");
}
function getDispatchWay(){
	return {
		"billId"			:jQuery("#billId").val(),
		"itemClassId"		:jQuery("#itemClassId").val(),
		"ornaClassId"		:jQuery("#ornaClassId").val(),
		"analysisId"		:jQuery("#analysisId").val(),
		"styleItemClassId"	:jQuery("#styleItemClassId").val(),
		"styleMiddleClassId":jQuery("#styleMiddleClassId").val(),
		"styleOrnaClassId"	:jQuery("#styleOrnaClassId").val(),
		"orgId"				:jQuery("#orgId").val(),
		"styleId"			:jQuery("#styleId").val(),
		"dispMin"			:jQuery("#dispMin").val(),
		"dispMax"			:jQuery("#dispMax").val()
	};
}
function checkValid(){
	if(parseFloat(jQuery("#dispMin").val())>parseFloat(jQuery("#dispMax").val())){
    	alert("铺货量最小值 不能大于铺货量最大值");
    	return false;
	}
	return true;
}
function saveDispatchStyle(){
	if(!Validator.Validate($("frm2"),3))
		return;
	if(!checkValid())	return false;
	confirm("确定保存?", function(){
		showLayer(true);
    	DispatchWayDwr.saveOrUpdateDispatchStyle(getDispatchWay(), function(data){
    		showLayer(false);
    		alert(data?data:"保存成功", function(){
    			if(!data){
                	window.location = "dispatchWay.vm?user_action=styleList";
    			}
    		});
    	});
	});
}
function saveDispatchStyleAndCopy(){
	if(!Validator.Validate($("frm2"),3))
		return;
	if(!checkValid())	return false;
	confirm("确定保存?", function(){
		showLayer(true);
    	DispatchWayDwr.saveOrUpdateDispatchStyle(getDispatchWay(), function(data){
    		showLayer(false);
    		alert(data?data:"保存并复制成功", function(){
    			if(!data){
					jQuery("#billId").val("");
					refreshFlag = true;//页面需要刷新
    			}
    		});
    	});
	});
}
jQuery(function(){
	checkTable('tbl', 'chkall', 'chk', true, null, function(index){
		showEidtDialog(index);
	});
	
	initQuery2('${queryCode}', "frm", 'btnQueryShow');
	resetWinSize();
	
	BdCommonDwr.getAllItemClassForSlt(function(data){
		addOptions("itemClassId", data, null, null, true, true);
	});
});
function showImportWin(){
	jQuery("#importExcelDiv").dialog({
			title:'导入Excel',
			width:400, 
			height:150,
			modal:true,
			zIndex:1,
			close:function(){
				if(refreshFlag){
            		window.location = "dispatchWay.vm?user_action=styleList";
            	}else{
                	jQuery('#turnoverNumDiv').dialog('close');
            	}
			}
		});
}
function ajaxFileUpload() {
	if(isNull(jQuery("#excel_file").val())){
		alert("请选择上传文件");
		return ;
	}
	confirm("确定要上传？", function(){
		//showLayer(true);
		var url = 'dispatchWay.vm?user_action=importExcelStyle';
		jQuery.ajaxFileUpload({
			url : url, //需要链接到服务器地址
			secureuri : false,
			fileElementId : 'excel_file', //文件选择框的id属性
			dataType : 'json', //服务器返回的格式，可以是json
			success : function (data, status) {
				//showLayer(false);
				if(data.isSuccess === "true"){
					var msg = "上传成功";
					alert(msg, function(){
						window.location = "dispatchWay.vm?user_action=styleList";
					});
				} else {
					alert(data.msg);
				}
			},
			error : function (data, status, e) {
				//showLayer(false);
				alert("上传失败");
			}
		});
	});
}

</script>