#set($cssfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.css"])
#set($jsfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.js",
	"$StringUtil.getContextPath()/js/move/moveReceive.js",
	"$StringUtil.getContextPath()/dwr/interface/MoveReceiveDwr.js"])

#if("1" == $!{form.billType})
	#set($modelCode = '0803010902')
#elseif("2" == $!{form.billType})
	#set($modelCode = '0803011002')
#elseif("3" == $!{form.billType})
	#set($modelCode = '0803011102')
#end
<form id='frm' action="" method="post">
	<input type='hidden' id='billType' value='$!{form.billType}'/>
	<input type='hidden' id='jmFlag' value='$!{form.jmFlag}'/>
	<input type='hidden' id='headid' value='$!{form.head.headid}'/>
    <table class="title">
    	<tr><td>$!DictUtil.getValue("movebilltype", $!form.billType)接收</td></tr>
    </table>
    <table class="control">
    	<tr>
			<td>
				<input type='button' value='未接收饰品' class='btn' id='btnUnreceive' $RightUtil.able($session, $modelCode,'1')>
				<input type='button' value='已入库饰品' class='btn' id='btnInivOrna' $RightUtil.able($session, $modelCode,'2')>
				<input type='button' value='入库' class='btn' id='btnIniv' $RightUtil.able($session, $modelCode,'3')>
				<input type='button' value='关闭' class='btn' id='btnClose' $RightUtil.able($session, $modelCode,'4')>
			#if("1" == "$!{form.billType}" && ("8" == "$!{form.head.status}" || "7" == "$!{form.head.status}"))
				<input type='button' value='生成标签申请单' class='btn' id='btnCreateLabelApply' $RightUtil.able($session, $modelCode,'5') #if("$!{form.head.labelApplyFlag}" == "1") disabled #end>
			#end
				<input type='button' value='返回列表' class='btn' id="btnToList">
			</td>
		</tr>
    </table>
    <table class='content'>
    	<tr>
			<td class='body1'>单据编号</td><td class='body2'><input type='text' readonly id='billno' value='$!{form.head.billno}'/></td>
			<td class='body1'>单据状态</td><td class='body2'><input type='text' readonly id='status' value="$!DictUtil.getValue('status', $!{form.head.status})"/></td>
			<td class='body1'>调拨日期</td><td class='body2'><input type='text' readonly id='dodate' value='$!{form.head.dodate}'/></td>
			<td class='body1'>创建人</td><td class='body2'><input type='text' readonly id='createId' value='$!BdCommon.getUserName($!{form.head.createId})'/></td>
		</tr>
    	<tr>
			<td class='body1'>调出组织</td><td class='body2'>
				<input type='hidden' id='outOrgId' value="$!{form.head.outOrgId}">
				<input type='text' id='outOrgName' value="$!BdCommon.getOrgName($!{form.head.outOrgId})" readonly>
			</td>
			<td class='body1'>调出仓库</td><td class='body2'>
				<input type='hidden' id='outStockId' value="$!{form.head.outStockId}">
				<input type='text' id='outStockName' value="$!DictUtil.getValue('invcode', $!{form.head.outStockId})" readonly>
			</td>
			<td class='body1'>调入组织</td><td class='body2'>
				<input type='hidden' id='inOrgId' value="$!{form.head.inOrgId}">
				<input type='text' id='inOrgName' value="$!BdCommon.getOrgName($!{form.head.inOrgId})" readonly>
			</td>
			<td class='body1'>调入仓库</td><td class='body2'>
				<input type='hidden' id='inStockId' value="$!{form.head.inStockId}">
				<input type='text' id='inStockName' value="$!DictUtil.getValue('invcode', $!{form.head.inStockId})" readonly>
			</td>
		</tr>
    	<tr>
			<td class='body1'>接收日期</td><td class='body2'><input type='text' readonly id='receiveDate' value='$!{form.head.receiveDate}'/></td>
			<td class='body1'>接收人员</td><td class='body2'><input type='text' readonly id='receiveEmpId' value='$!BdCommon.getUserName($!{form.head.receiveEmpId})'/></td>
		</tr>
    	<tr>
			<td class='body1'>件数合计</td><td class='body2'><input type='text' readonly id='sumCount' value='$!{form.head.sumCount}'/></td>
			<td class='body1'>已接收件数</td><td class='body2'><input type='text' readonly id='receCount' value='$!{form.head.receCount}'/></td>
			<td class='body1'>未接收件数</td><td class='body2'><input type='text' readonly id='noreceCount' value='$!{form.head.noreceCount}'/></td>
			<td class='body1'>作废件数</td><td class='body2'><input type='text' readonly id='discardCount' value='$!{form.head.discardCount}'/></td>
		</tr>
    	<tr>
			<td class='body1'>饰品条码</td><td class='body2'><input type='text' id='barCode_in' value=''/></td>
			<td class='body1'>饰品编码</td><td class='body2'><input type='text' id='ornaCode_in' value=''/></td>
			<td class='body1'>备注</td><td class='body2' colspan="3"><input type='text' id='memo' readonly value='$!{form.head.memo}' style="width:95%;"/></td>
		</tr>
    </table>
	<table class='list'>
		<thead>
			<tr>
				<th></th>
				<th>饰品编码</th>
				<th>饰品名称</th>
				<th>调入柜组</th>
				<th>大类</th>
				<th>小类</th>
				<th>分析范围</th>
				<th>款式</th>
				<th>计量单位</th>
				<th>总重量</th>
				<th>现有量</th>
				<th>粒数</th>
				<th>销售金额</th>
				<th>主石重</th>
				<th>配石重</th>
				<th>状态</th>
				<th width='60px;'></th>
			</tr>
		</thead>
		<tbody id='tbl'>
		#foreach($item in $form.lineList)
			<tr>
				<td>
					<input type='checkbox' name='chk'/>
            		<input type='hidden' name='lineid' value='$!{item.lineid}'/>
            		<input type='hidden' name='ornaCode' value='$!{item.ornaCode}'/>
            		<input type='hidden' name='barCode' value='$!{item.barCode}'/>
            		<input type='hidden' name='allWeight' value='$!{item.allWeight}'/>
            		<input type='hidden' name='posCost' value='$!{item.posCost}'/>
            		<input type='hidden' name='posAmount' value='$!{item.posAmount}'/>
            		<input type='hidden' name='grains' value='$!{item.grains}'/>
				</td>
				<td>$!item.ornaCode</td>
				<td>$!item.ornaDsc</td>
				<td><select name='inGroupNo' style='width:60px;' onchange="changeInGroupNo(this)">${HtmlUtil.printDictOptions('group', true, $!item.inGroupNo)}</select></td>
				<td>$!BdCommon.getItemClassDesc($!item.itemClassId)</td>
				<td>$!BdCommon.getOrnaClassDesc($!item.ornaClassId)</td>
				<td>$!item.analysisName</td>
				<td>$!HtmlUtil.printStyle($!item.styleId, $!item.styleName, $!item.bigGraph)</td>
				<td>$!BdCommon.getUnitName($!item.unitId)</td>
				<td>$!item.allWeight</td>
				<td>$!item.nowQty</td>
				<td>$!item.grains</td>
				<td>$!item.posAmount</td>
				<td>$!item.mainWeight</td>
				<td>$!item.partWeight</td>
				<td>$!DictUtil.getValue('status', $!item.status)</td>
				<td><input type='button' class='btn' value='删除' onclick='deleteMoveRow(this)'/></td>
			</tr>
		#end
        </tbody>
    </table>
</form>
<script>
jQuery(function(){
	altRowCSS('tbl');
	jQuery("#btnToList").click(backtoList);
	jQuery("#btnUnreceive").click(showUnreceiveOrna);
	jQuery("#btnInivOrna").click(showInivOrna);
	jQuery("#btnIniv").click(inivMoveLine);
	jQuery("#btnClose").click(closeMoveBill);
	jQuery("#btnCreateLabelApply").click(createLabelApply);
	setEnterKey('ornaCode_in', getMoveLineByOrnaCode);
	setEnterKey('barCode_in', getMoveLineByBarCode);
	changeButtons();
});
function backtoList(){
	window.location = "moveReceive.vm?billType=$!{form.billType}&jmFlag=$!{form.jmFlag}";
}
function showUnreceiveOrna(){
	var _iframeId = "unreceiveOrnaFrm";
	var options = {
			title : '未接收饰品[状态：保存/作废]',
			contentType : 'iframe',
			iframeId : _iframeId,
			width : 800,
			height : 330,
			okBtnName : '选择',
			onok : function(box) {
				var result = jQuery("#" + _iframeId)[0].contentWindow.getValues();
				if(!result){alert("请先选择饰品");return;}
    			jQuery("#ornaCode_in").val(result);
    			box.close();// 增加事件方法后需手动关闭弹窗
			},
			oncancel : function(box) {
				box.close();
			}
	};
	var url =ctxPath + '/move/moveReceive.vm?user_action=unreceive&headid=' + jQuery("#headid").val();
	//info(url);
	jQuery.weeboxs.open(url, options);
}
function showInivOrna(){
	var _iframeId = "inivOrnaFrm";
	var options = {
			title : '已入库饰品[状态：已入库]',
			contentType : 'iframe',
			iframeId : _iframeId,
			width : 850,
			height : 330,
			cancelBtnName : '关闭',
			showOk:false,
			oncancel : function(box) {
				box.close();
			}
	};
	var url =ctxPath + '/move/moveReceive.vm?user_action=inivOrna&headid=' + jQuery("#headid").val();
	//info(url);
	jQuery.weeboxs.open(url, options);
}
/**
 * 入库
 * 将已经接收的饰品入库，并更改状态为已入库11
 */
function inivMoveLine(){
	for(var i=0, j=$n("ornaCode").length;i<j;i++){
		if(isNull($n("inGroupNo")[i].value)){
			alert("请先为行表入库的饰品选择 调入柜组");
			return ;
		}
	}
	confirm("确定将列表中"+$n("ornaCode").length+"件饰品入库?", function(){
    	showLayer(true);
    	MoveReceiveDwr.inivMoveLine(jQuery("#headid").val(), jQuery("#billType").val(), jQuery("#jmFlag").val(), function(data){
			showLayer(false);
    		alert(data?data:"入库成功", function(){
    			if(!data){
					window.location = "moveReceive.vm?user_action=toEdit&headid=" + jQuery("#headid").val();
    			}
    		});
    	});
	});
}
/**
 * 关闭
 */
function closeMoveBill(){
	var flag = parseInt(jQuery("#noreceCount").val())>0;
	confirm(flag?"当前还有"+jQuery("#noreceCount").val()+"件饰品未接收且未入库，确定关闭?":"确定关闭?", function(){
		showLayer(true);
    	MoveReceiveDwr.closeMoveBill(jQuery("#headid").val(), function(data){
			showLayer(false);
    		alert(data?data:"关闭成功", function(){
    			if(!data){
    				backtoList();
    			}
    		});
    	});
	});
}
function changeButtons(){
	jQuery("#btnIniv").attr("disabled", true);
	jQuery("#btnClose").attr("disabled", true);
	
	if("14" == "$!{form.head.status}"){//接收中
		//当不存在已接收的调拨单行，此时可以进行关闭
		if($n("ornaCode").length<1){
    		jQuery("#btnClose").attr("disabled", false);
		}
		//存在已接收调拨单行
		if($n("ornaCode").length>0){
			jQuery("#btnIniv").attr("disabled", false);
		}
	}
}
/**
 * 生成标签申请单
 */
function createLabelApply(){
	confirm("确定生成标签申请单?", function(){
		showLayer(true);
    	MoveReceiveDwr.createLabelApply(jQuery("#headid").val(), function(data){
			showLayer(false);
        	jQuery("#btnCreateLabelApply").attr("disabled", true);
    		alert(data?data:"生成标签申请单成功", function(){
    			if(!data){
    				backtoList();
    			}
    		});
    	});
	});
}
</script>