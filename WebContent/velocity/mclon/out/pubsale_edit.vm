#set($jsfiles = ["$StringUtil.getContextPath()/js/out/pubSale.js?t=201204091727.js",
"$StringUtil.getContextPath()/dwr/interface/OutVendorDwr.js?t=201204091727.js",
"$StringUtil.getContextPath()/script/mclon/calendar/calendar.js"])
#set($cssfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.css"])
	
<form id='frm' action="outVendor.vm" method="post">
	#set($pubSale = $form.head)
	#set($enableSave = true)
	#set($enableAudit = true)
	#set($enableInvaid = false)
	#set($enableClose = false)
	#set($enableCash = false)
	#set($modelCode = '08040102')
	#if($StringUtil.isNotBlank($pubSale.status))
		#if("$!StringUtil.getOrgId($session)" == "$!pubSale.orgId")
    		#if($pubSale.status == "1")
    			#set($enableAudit = true)
    			#set($enableSave = true)
    		#elseif($pubSale.status == "5")##审批完成
            	#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = false)
            	#set($enableClose = true)
    		#elseif($pubSale.status == "8")##关闭状态
    			#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = true)
            	#set($enableClose = false)
				#set($enableCash = true)
    		#else
    			#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = false)
            	#set($enableClose = false)
    		#end
		#else
			#set($enableSave = false)
        	#set($enableAudit = false)
		#end
	#end
	<input type="hidden" id="user_action" name="user_action" value=""/>
	<input type="hidden" name="dotype" value="0"/>
	<input type="hidden" id="headId" name="headId" value="$!{pubSale.headId}"/>
    <table class="title">
    	<tr><td>对公销售详细页</td></tr>
    </table>
    <table class="control">
    	<tr><td>
				<input type='button' value='保存' #if(!$enableSave)disabled#end class='btn' id='btnSave' $RightUtil.able($session, $modelCode,'1')>
				<input type='button' value='审核' #if(!$enableAudit)disabled#end class='btn' id='btnCheck' $RightUtil.able($session, $modelCode,'2')>
				<input type='button' value='关闭' #if(!$enableClose)disabled#end class='btn' id='btnClose' $RightUtil.able($session, $modelCode,'3') onClick="changeState($pubSale.headId,8,'确认关闭此单据')">
				<input type='button' value='结算' #if(!$enableCash)disabled#end class='btn' id='btnCash' $RightUtil.able($session, $modelCode,'6')>
				<input type='button' value='打印' class='btn' id='btnPrint' onclick="window.print()" $RightUtil.able($session, $modelCode,'4')>
				<input type='button' value='作废' #if(!$enableInvaid)disabled#end class='btn' id='btnInvalid' $RightUtil.able($session, $modelCode,'5') onClick="changeState($pubSale.headId,13,'确认作废此单据')">
				<input type='button' value='Excel' class='btn' id='exportToExcel' onclick="exportListToExcel()">
				<input type='button' value='返回列表' class='btn' id="btnToList">
		</td></tr>
    </table>
    <table class='content'>
		#if($StringUtil.isEmpty($pubSale.headId))
			#set($doDate = "$!DateUtil.getCurrentDate10()")
			#set($billno = "自动生成")
		#else
			#set($doDate = $pubSale.doDate)
			#set($billno = $pubSale.billNo)
		#end
		#set($state = $!DictUtil.getValue('status', $!pubSale.status))
    	<tr>
			<td class='body1'>单据编号：</td>
			<td class='body2'>
				<input type='text' id="billNo" name='billNo' readonly value="$!billno">
			</td>
			<td class='body1'>单据日期：</td>
			<td class='body2'>
				<input type='text' id="doDate" name='doDate' readonly value="$!doDate" dataType="Require" msg="不能为空">
				$StringUtil.star()
			</td>
			<td class='body1'>库存组织:</td>	
			<td class='body2'>
				<input type='hidden' id="orgId" name='orgId' value="$!{pubSale.orgId}">
				<input type='text' id="orgName" name='orgName'  value="$!BdCommon.getOrgName($pubSale.orgId)" readonly  dataType="Require" msg="不能为空">
				$StringUtil.star()
			</td>
			<td class='body1'>单据状态：</td>	
			<td class='body2'>
				<input type='hidden' id="status" name='status' value="$!{pubSale.status}">
				<input type='text' id="statusName" name='statusName' readonly value="$!state">
			</td>
		</tr>
		<tr>
			<td class='body1'>件数合计：</td>	
			<td class='body2'>
				<input type='text' id="sumCount" name='sumCount' readonly value="$!{pubSale.sumCount}">
			</td>
			<td class='body1'>重量合计：</td>	
			<td class='body2'>
				<input type='text' id="sumWeight" readonly name='sumWeight' value="$!{pubSale.sumWeight}">
			</td>
			<td class='body1'>粒数合计：</td>
			<td class='body2'>
				<input type='text' id="sumGrains" readonly name='sumGrains' value="$!{pubSale.sumGrains}">
			</td>
			<td class='body1'>含税金额：</td>
			<td class='body2'>
				<input type='hidden' id="sumCost" name='sumCost' value="$!{pubSale.sumCost}">
				<input type='text' id="sumMoney" name='sumMoney' readonly value="$!{pubSale.sumMoney}">
			</td>
		</tr>
		<tr>
			<td class='body1'>供应商：</td>	
			<td class='body2'>
				<input type='hidden' id='vendorId' name="vendorId" value="$!{pubSale.vendorId}">
				<input type='text' id='vendorName' value="$!BdCommon.getVendorName($!{pubSale.vendorId})" readonly class='target' ondblclick="showVendorWin()" dataType="Require" msg="不能为空">$StringUtil.star()
			</td>
			<td class='body1'>实际销售金额：</td>
			<td class='body2'>
				<input type='text' id="saleMoney" name='saleMoney' dataType="Double" msg="不能为空,且只能为数字" value="$!{pubSale.saleMoney}">$StringUtil.star()
			</td>
			<td class='body1'>仓库</td><td class='body2'>
				<select id='stockId' name='stockId' dataType="Require" msg="不能为空"></select>$StringUtil.star()
			</td>	
		</tr>
		<tr>
			<td class='body1'>饰品条码：</td>
			<td class='body2'>
				<input type='text' id="ornaBarCode" name='ornaBarCode' value="">
			</td>
			<td class='body1'>饰品编码：</td>
			<td class='body2'>
				<input type='text' id="ornaCode" name='ornaCode'  value="">
			</td>
			<td class='body1'>备注：</td>
			<td class='body2' colspan="3">
				<input type="text" id="memo" name="memo" style="width:90%;" value="$!{pubSale.memo}"/>
			</td>
		</tr>
    </table>
	<div class="scroll2">
	    <table class='list' style="width:1200px;">
    	<thead>
			<tr>
				<th width='30px'>行号</th>
				<th width='60px'>大类</th>
				<th width='60px'>小类</th>
				<th width='120px'>款式</th>
                <th width='90px'>分析范围</th>
        		<th width='90px'>饰品编码</th>
        		<th width='90px'>饰品名称</th>
				<th width='90px'>计量单位</th>
				<th width='60px'>现有量</th>
				<th width='60px'>总重量</th>
				<th width='60px'>粒数</th>
				<th width='60px'>销售金额</th>
				<th width='60px'>主石重量</th>
        		<th width='69px'>配石重量</th>
				##if(!$StringUtil.isNotBlank($pubSale.status)||$StringUtil.isNotBlank($pubSale.status)&&$pubSale.status == "1")
					<th width='60px'>操作</th>
				##end
            </tr>
        </thead>
        <tbody id="tbl">
		#foreach($map in $form.list)
			<tr>
				<td>$velocityCounter</td>
				<td>$!BdCommon.getItemClassDesc($map.itemClassId)</td>
				<td>$!BdCommon.getOrnaClassDesc($map.ornaClassId)</td>
				<td>$!HtmlUtil.printStyle($!map.styleId, $!map.styleName, $!map.bigGraph)</td>
				<td>$!map.alaysisCode</td>
                <td>$!map.ornaCode</td>
                <td>$!map.ornaDsc</td>
				<td>$!BdCommon.getUnitName($map.unitId)</td>
				<td>$!StringUtil.formatDouble($!map.nowQty,10)</td>
				<td>$!StringUtil.formatDouble($!map.allQty,10)</td>
				<td>$!map.grains</td>
				<td>$!map.posMoney</td>
				<td>$!map.mainWeight</td>
				<td>$!map.partWeight</td>
				<td>
				<input type='hidden' name="#lineId" value="$!map.lineId">
				<input type='hidden' name="#itemClassId"  value="$!map.itemClassId">
				<input type='hidden' name="#ornaClassId"  value="$!map.ornaClassId">
				<input type='hidden' name="#styleId"  value="$!map.styleId">
				<input type='hidden' name="#alaysisId"  value="$!map.alaysisId">
				<input type='hidden' name="#ornaCode"  value="$!map.ornaCode">
				<input type='hidden' name="#ornaBarCode"  value="$!map.ornaBarCode">
				<input type='hidden' name="#ornaDsc"  value="$!map.ornaDsc">
				<input type='hidden' name="#unitId"  value="$!map.unitId">
				<input type='hidden' name="#nowQty"  value="$!map.nowQty">
				<input type='hidden' name="#allQty"  value="$!map.allQty">
				<input type='hidden' name="#grains"  value="$!map.grains">
				<input type='hidden' name="#mainWeight"  value="$!map.mainWeight">
				<input type='hidden' name="#partWeight"  value="$!map.partWeight">
				<input type='hidden' name="#isMutiPart"  value="$!map.isMutiPart">
				<input type='hidden' name="#isDblLabel"  value="$!map.isDblLabel">
				<input type='hidden' name="#posCost"  value="$!map.posCost">
				<input type='hidden' name="#isPSale"  value="$!map.isPSale">
				<input type='hidden' name="#posMoney"  value="$!map.posMoney">
				<input type='hidden' name="#styleOrnaClass"  value="$!map.styleOrnaClass">
				<input type='hidden' name="#styleItemClass"  value="$!map.styleItemClass">
				<input type='hidden' name="#styleMiddleClass"  value="$!map.styleMiddleClass">
				#if(!$StringUtil.isNotBlank($pubSale.status)||$StringUtil.isNotBlank($pubSale.status)&&$pubSale.status == "1")
				<input type='button' class='btn' value='删除' onclick="deleteLine(this,$!map.lineId)">
				#end
				</td>
			</tr>
		#end
    	</tbody>
    </table>
	</div>
</form>
<script>
function showVendorWin(){
	selectVendor(function(idArr, nameArr){
		jQuery("#vendorId").val(idArr.join(','));
		jQuery("#vendorName").val(nameArr.join(','));
	}, null, null, false, jQuery("#vendorId").val());
}
jQuery(function(){
	checkTable('tbl');
	changeSeq("tbl");
	var dw = jQuery(document).width();
	if(dw > 1000){
		jQuery(".list").css("width", dw+"px");
	}
	jQuery("#btnSave").click(function(){saveform(1);});
	jQuery("#btnCheck").click(function(){saveform(4);});
	jQuery("#btnCash").click(cashCharge);
	setEnterKey("ornaCode",function(){
		var stockId=jQuery("#stockId").val();
		if(!stockId){
    		alert("请选择仓库");
			jQuery("#ornaCode").val("");
    		return;
		}
		var state=document.getElementById("status").value;
		if(state!="1")return;
		var code=jQuery("#ornaCode").val();
		if(code){
			if(checkOrnaCode(code)){
				alert("此饰品编码已经存在,请重新输入!")
			}else
				OutVendorDwr.getOrnaInfo(jQuery("#orgId").val(), null,jQuery("#ornaCode").val(),true,stockId,addRow);
			jQuery("#ornaCode").val("");
		}
	});
	setEnterKey("ornaBarCode",function(){
			    var stockId=jQuery("#stockId").val();
		if(!stockId){
    		alert("请选择仓库");
			jQuery("#ornaBarCode").val("");
    		return;
		}
		var state=document.getElementById("status").value;
		if(state!="1")return;
		var barCode=jQuery("#ornaBarCode").val();
		if(barCode){
			if(checkOrnaCode(barCode,true)){
				alert("此饰品条码已经存在,请重新扫描!")
			}else
				OutVendorDwr.getOrnaInfo(jQuery("#orgId").val(), null, jQuery("#ornaBarCode").val(),false,stockId,addRow);
			jQuery("#ornaBarCode").val("");
		}
	});
	jQuery("#btnToList").click(function(){
		window.location = "outVendor.vm?user_action=toPubSaleList";
	});
	 resetSum();
     new Calendar({
      inputField: "doDate",
      dateFormat: "%Y-%m-%d",
      trigger: "doDate",
      bottomBar: true,
      showTime:false,
      value:new Date(),
      onSelect: function() {
        this.hide();
      }
    });
	checkReview();	
	DictDwr.getDictsForSlt("invcode", function(data){
    		addOptions("stockId", data, null, null, true, true, "$!{pubSale.stockId}");
    	});
})
function exportListToExcel(){
	jQuery("#user_action").val("exportExcelLine");
	jQuery("#frm").submit();
	jQuery("#user_action").val("toEditPubsale");
}
</script>