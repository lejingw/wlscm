#set($jsfiles = [
"$StringUtil.getContextPath()/dwr/interface/OutBackDwr.js"])
	
<form id='frm' action="outBack.vm" method="post">
	#set($outBack = $form.head)
	<input type="hidden" id="user_action" name="user_action" value=""/>
	<input type="hidden" id="headId" name="headId" value="$!{outBack.headId}"/>
    <table class="title">
    	<tr><td>对公销售详细页</td></tr>
    </table>
    <table class='content'>
		<tr>
			<td class='body1'>饰品条码：</td>
			<td class='body2'>
				<input type="hidden" id="headId" name="headId" value="$!{outBack.headId}"/>
				<input type='text' id="ornaBarCode" name='ornaBarCode' value="">
			</td>
			<td class='body1'>饰品编码：</td>
			<td class='body2'>
				<input type='text' id="ornaCode" name='ornaCode'  value="">
			</td>
			<td class='body1'>备注：</td>
			<td class='body2' colspan="3">
				<input type="text" id="memo" name="memo" style="width:90%;" />
			</td>
		</tr>
    </table>
	<table class='list'>
    	<thead>
			<tr>
				<th>大类</th>
				<th>小类</th>
				<th>款式</th>
                <th>分析范围</th>
        		<th>饰品编码</th>
        		<th>饰品名称</th>
				<th>计量单位</th>
				<th>现有量</th>
				<th>粒数</th>
				<th>主石重量</th>
				<th width='60px'></th>
            </tr>
        </thead>
        <tbody id="tbl">
    	</tbody>
    </table>
</form>
<script>
setEnterKey("ornaCode",function(){
	var code=jQuery("#ornaCode").val();
	if(code){
		if(checkOrnaCode(code)){
			alert("此饰品编码已经存在,请重新输入!")
		}else
			OutBackDwr.getBackLine(jQuery("#headId").val(),jQuery("#ornaCode").val(),true,addRow);
		jQuery("#ornaCode").val("");
	}
});
setEnterKey("ornaBarCode",function(){
	var barCode=jQuery("#ornaBarCode").val();
	if(barCode){
		if(checkOrnaCode(barCode,true)){
			alert("此饰品条码已经存在,请重新扫描!")
		}else
			OutBackDwr.getBackLine(jQuery("#headId").val(),jQuery("#ornaBarCode").val(),false,addRow);
		jQuery("#ornaBarCode").val("");
	}
});
var backLines=[];
function addRow(line){
	var itemClassId=line.itemClassId;
	var ornaClassId=line.ornaClassId;
	var styleId=line.styleName;
	var alaysisId=line.alaysisCode||"";
	var ornaCode=line.ornaCode||"";
	var ornaDsc=line.ornaDsc||"";
	var unitName=line.unitName||"";
	var nowQty=line.nowQty||"";
	var allQty=line.allQty||"";
	var grains=line.grains||"";
	var posAmount=line.posAmount||"";
	var mainWeight=line.mainWeight||"";
	var partWeight=line.partWeight||"";
	var del="<input type='button' class='btn' value='删除' onclick='deleteLine(this,"+line.lineId+")'>"+
		"<input type='hidden' name=\"#ornaCode\"  value=\""+ornaCode+"\">" + 
		"<input type='hidden' name=\"#ornaBarCode\"  value=\""+line.ornaBarCode+"\">";
	insertRow("tbl", [ line.itemClassName, line.ornaClassName, "<a href='javascript:viewStyle(\""+line.styleId+"\")'>"+styleId+"</a>", alaysisId, ornaCode, ornaDsc, unitName,
	                   nowQty, grains,  mainWeight, del ],
			true);
	backLines[backLines.length]=line.lineId;
}
function deleteLine(obj,id){
	for(var i=0;i<backLines.length;i++){
		if(backLines[i]==id){
			backLines[i]="";
			deleteRow(obj, "tbl");
			break;
		}
	}
}
function checkOrnaCode(code,barFlag){
	for(var i=0;i<$("tbl").rows.length;i++){
		var _code=barFlag?$n("#ornaBarCode")[i].value:$n("#ornaCode")[i].value;
		if(code==_code)
			return true;
	}
	return false;
}
function getValues(){
	var lines=[];
	for(var i=0;i<backLines.length;i++){
		if(backLines[i]){
			lines[i]=backLines[i];
		}
	}
	return [lines.join(","),jQuery("#memo").val(),lines.length];
}
</script>