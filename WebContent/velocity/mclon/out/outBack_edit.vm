#set($jsfiles = ["$StringUtil.getContextPath()/js/out/outBack.js",
"$StringUtil.getContextPath()/dwr/interface/OutBackDwr.js",
"$StringUtil.getContextPath()/script/mclon/calendar/calendar.js"])
#set($cssfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.css"])
	
<form id='frm' action="outBack.vm" method="post">
	#set($outBack = $form.head)
	#set($enableSave = true)
	#set($enableAudit = true)
	#set($enableInvaid = false)
	#set($enableClose = false)
	#set($modelCode = '08040802')
	#if($StringUtil.isNotBlank($outBack.status))
		#if("$!StringUtil.getOrgId($session)" == "$!outBack.orgId")
    		#if($outBack.status == "1")
    			#set($enableAudit = true)
    			#set($enableSave = true)
    		#elseif($outBack.status == "5")##审批完成
            	#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = true)
            	#set($enableClose = true)
    		#elseif($outBack.status == "10")##关闭状态
    			#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = false)
            	#set($enableClose = false)
    		#else
    			#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = false)
            	#set($enableClose = false)
    		#end
		#else
			#set($enableSave = false)
        	#set($enableAudit = false)
		#end
	#end
	<input type="hidden" id="user_action" name="user_action" value=""/>
	<input type="hidden" id="headId" name="headId" value="$!{outBack.headId}"/>
    <table class="title">
    	<tr><td>借出归还单详细页</td></tr>
    </table>
    <table class="control">
    	<tr><td>
				<input type='button' #if(!$enableSave)disabled#end value='保存' class='btn' id='btnSave' $RightUtil.able($session, $modelCode,'1')>
				<input type='button' #if(!$enableAudit)disabled#end value='审核' class='btn' id='btnCheck' $RightUtil.able($session, $modelCode,'2')>
				<!--
				<input type='button' #if(!$enableClose)disabled#end value='出库' class='btn' id='btnClose' onClick="changeState($outBack.headId,10,'确认所有饰品出库')">
				-->
				<input type='button' value='打印' class='btn' id='btnPrint' onclick="window.print()" $RightUtil.able($session, $modelCode,'3')>
				<input type='button' #if(!$enableInvaid)disabled#end value='归还' class='btn' id='btnInvalid' onClick="backInfo($outBack.headId)" $RightUtil.able($session, $modelCode,'4')>
				<input type='button' value='Excel' class='btn' id='exportToExcel' onclick="exportListToExcel()">
				<input type='button'  value='返回列表' class='btn' id="btnToList">
		</td></tr>
    </table>
    <table class='content'>
		#if($StringUtil.isEmpty($outBack.headId))		
			#set($doDate = "$!DateUtil.getCurrentDate10()")
			#set($billno = "自动生成")
		#else
			#set($doDate = $outBack.doDate)
			#set($billno = $outBack.billNo)
		#end
		#set($state = $!DictUtil.getValue('status', $!outBack.status))
    	<tr>
			<td class='body1'>单据编号：</td>
			<td class='body2'>
				<input type='text' id="billNo" name='billNo' readonly value="$!billno">
			</td>
			<td class='body1'>单据日期：</td>
			<td class='body2'>
				<input type='text' id="doDate" name='doDate' readonly value="$!doDate" dataType="Require" msg="不能为空">
				$StringUtil.star()
			</td>
			<td class='body1'>库存组织:</td>	
			<td class='body2'>
				<input type='hidden' id="orgId" name='orgId' value="$!{outBack.orgId}">
				<input type='text' id="orgName" name='orgName'  value="$!BdCommon.getOrgName($outBack.orgId)" readonly  dataType="Require" msg="不能为空">
				$StringUtil.star()
			</td>
			<td class='body1'>单据状态：</td>	
			<td class='body2'>
				<input type='hidden' id="status" name='status' value="$!{outBack.status}">
				<input type='text' id="statusName" name='statusName' readonly value="$!state">
			</td>
		</tr>
		<tr>
			<td class='body1'>件数合计：</td>	
			<td class='body2'>
				<input type='text' id="sumCount" name='sumCount' readonly value="$!{outBack.sumCount}">
			</td>
			<td class='body1'>重量合计：</td>	
			<td class='body2'>
				<input type='text' id="sumWeight" readonly name='sumWeight' value="$!{outBack.sumWeight}">
			</td>
			<td class='body1'>粒数合计：</td>
			<td class='body2'>
				<input type='text' id="sumGrains" readonly name='sumGrains' value="$!{outBack.sumGrains}">
			</td>
			<td class='body1'>金额合计：</td>
			<td class='body2'>
				<input type='hidden' id="sumCost" name='sumCost' value="$!{outBack.sumCost}">
				<input type='text' id="sumMoney" name='sumMoney' readonly value="$!{outBack.sumMoney}">
			</td>
		</tr>
		<tr>
			<td class='body1'>借用组织：</td>	
			<td class='body2'>
				<input type='hidden' id='outOrgId' name="outOrgId" value="$!{outBack.outOrgId}">
				<input type='text' id='outOrgName' value="$!BdCommon.getOrgName(${outBack.outOrgId})" readonly #if("$outBack.status" == "1") class="target" ondblclick="showSelectOrgWin()" #end>
			</td>
			<td class='body1'>借用人员：</td>	
			<td class='body2'>
				<input type='hidden' id='userId' name="userId" value="$!{outBack.userId}">
				<input type='text' id='userName' value="$!{BdCommon.getUserName($outBack.userId)}" readonly #if("$outBack.status" == "1") class="target" ondblclick="showSelectUserWin()" #end>
			</td>
			<td class='body1'>归还数量：</td>
			<td class='body2'>
				<input type='text' id="backSum" name='backSum' readonly value="$!{outBack.backSum}">
			</td>
			<td class='body1'>仓库</td><td class='body2'>
				<select id='stockId' name='stockId' dataType="Require" msg="不能为空"></select>$StringUtil.star()
			</td>
		</tr>
		<tr>
			<td class='body1'>饰品条码：</td>
			<td class='body2'>
				<input type='text' id="ornaBarCode" name='ornaBarCode' value="">
			</td>
			<td class='body1'>饰品编码：</td>
			<td class='body2'>
				<input type='text' id="ornaCode" name='ornaCode'  value="">
			</td>
			<td class='body1'>备注：</td>
			<td class='body2' colspan="3">
				<input type="text" id="memo" name="memo" style="width:90%;" value="$!{outBack.memo}"/>
			</td>
		</tr>
    </table>
	<div class="scroll2">
	    <table class='list' style="width:1400px;">
    	<thead>
			<tr>
				<th width='35px'>行号</th>
				<th width='90px'>大类</th>
				<th width='90px'>小类</th>
				<th width='90px'>款式</th>
                <th width='90px'>分析范围</th>
        		<th width='90px'>饰品编码</th>
        		<th width='120px'>饰品名称</th>
				<th width='90px'>计量单位</th>
				<th width='60px'>现有量</th>
				<th width='60px'>总重量</th>
				<th width='60px'>粒数</th>
				<th width='90px'>销售金额</th>
				<th width='90px'>主石重量</th>
        		<th width='90px'>配石重量</th>
        		<th width='120px'>归还时间</th>
        		<th width='180px'>归还说明</th>
				#if(!$StringUtil.isNotBlank($outBack.status)||$StringUtil.isNotBlank($outBack.status)&&$outBack.status == "1")
					<th width='60px'></th>
				#end
            </tr>
        </thead>
        <tbody id="tbl">
		#foreach($map in $form.list)
			<tr>
				<td>$velocityCounter</td>
				<td>$!BdCommon.getItemClassDesc($map.itemClassId)</td>
				<td>$!BdCommon.getOrnaClassDesc($map.ornaClassId)</td>
				<td>$!HtmlUtil.printStyle($!map.styleId, $!map.styleName, $!map.bigGraph)</td>
				<td>$map.alaysisCode</td>
                <td>$!map.ornaCode</td>
                <td>$!map.ornaDsc</td>
				<td>$!BdCommon.getUnitName($map.unitId)</td>
				<td>$!StringUtil.formatDouble($!map.nowQty,2)</td>
				<td>$!StringUtil.formatDouble($!map.allQty,2)</td>
				<td>$!map.grains</td>
				<td>$!map.posMoney</td>
				<td>$!map.mainWeight</td>
				<td>$!map.partWeight</td>
				<td>$!map.backDate</td>
				<td><input readonly name="#backBody" value="$!map.backBody"></td>
				<td>
				<input type='hidden' name="#lineId" value="$!map.lineId">
				<input type='hidden' name="#itemClassId"  value="$!map.itemClassId">
				<input type='hidden' name="#ornaClassId"  value="$!map.ornaClassId">
				<input type='hidden' name="#styleId"  value="$!map.styleId">
				<input type='hidden' name="#alaysisId"  value="$!map.alaysisId">
				<input type='hidden' name="#ornaCode"  value="$!map.ornaCode">
				<input type='hidden' name="#ornaBarCode"  value="$!map.ornaBarCode">
				<input type='hidden' name="#ornaDsc"  value="$!map.ornaDsc">
				<input type='hidden' name="#unitId"  value="$!map.unitId">
				<input type='hidden' name="#nowQty"  value="$!map.nowQty">
				<input type='hidden' name="#allQty"  value="$!map.allQty">
				<input type='hidden' name="#grains"  value="$!map.grains">
				<input type='hidden' name="#mainWeight"  value="$!map.mainWeight">
				<input type='hidden' name="#partWeight"  value="$!map.partWeight">
				<input type='hidden' name="#isMutiPart"  value="$!map.isMutiPart">
				<input type='hidden' name="#isDblLabel"  value="$!map.isDblLabel">
				<input type='hidden' name="#posCost"  value="$!map.posCost">
				<input type='hidden' name="#isPSale"  value="$!map.isPSale">
				<input type='hidden' name="#posMoney"  value="$!map.posMoney">
				<input type='hidden' name="#styleOrnaClass"  value="$!map.styleOrnaClass">
				<input type='hidden' name="#styleItemClass"  value="$!map.styleItemClass">
				<input type='hidden' name="#styleMiddleClass"  value="$!map.styleMiddleClass">
				#if(!$StringUtil.isNotBlank($outBack.status)||$StringUtil.isNotBlank($outBack.status)&&$outBack.status == "1")
				<input type='button' class='btn' value='删除' #if(!$enableSave)disabled#end onclick="deleteLine(this,$!map.lineId)">
				#end
				</td>
			</tr>
		#end
    	</tbody>
    </table>
</form>
<script>

//显示组织选择窗口
function showSelectOrgWin(){
	if(!isNull("$!{form.outOrgId}")){
		alert("修改页面组织不可编辑");
		return ;
	}
	selectOrg(function(idArr, nameArr){
			if(idArr.join(",")!=jQuery("#outOrgId").val()){
    			jQuery("#outOrgId").val(idArr.join(","));
    			jQuery("#outOrgName").val(nameArr.join(","));
    			jQuery("#userId").val("");
    			jQuery("#userName").val("");
			}
		}, null, null, false, jQuery("#outOrgId").val());
}
function showSelectUserWin(){
	if(isNull(jQuery("#outOrgId").val())){
		alert("请先选择组织");
		return ;
	}
	selectEmp(function(idArr, nameArr){
			jQuery("#userId").val(idArr.join(","));
			jQuery("#userName").val(nameArr.join(","));
		}, null, null, false, [jQuery("#userId").val()], "getEmpByOrgId", {orgId:jQuery("#outOrgId").val()});
}
jQuery(function(){
	checkTable('tbl');
	changeSeq("tbl");
	jQuery("#btnSave").click(function(){saveform(1);});
	jQuery("#btnCheck").click(function(){saveform(4);});
	setEnterKey("ornaCode",function(){
		var stockId=jQuery("#stockId").val();
		if(!stockId){
    		alert("请选择仓库");
			jQuery("#ornaCode").val("");
    		return;
		}
		var code=jQuery("#ornaCode").val();
		if(code){
			if(checkOrnaCode(code)){
				alert("此饰品编码已经存在,请重新输入!")
			}else
				OutBackDwr.getOrnaInfo(jQuery("#orgId").val(),null,jQuery("#ornaCode").val(),true,stockId,addRow);
			jQuery("#ornaCode").val("");
		}
	});
	setEnterKey("ornaBarCode",function(){
			    var stockId=jQuery("#stockId").val();
		if(!stockId){
    		alert("请选择仓库");
			jQuery("#ornaBarCode").val("");
    		return;
		}
		var barCode=jQuery("#ornaBarCode").val();
		if(barCode){
			if(checkOrnaCode(barCode,true)){
				alert("此饰品条码已经存在,请重新扫描!")
			}else
				OutBackDwr.getOrnaInfo(jQuery("#orgId").val(),null,jQuery("#ornaBarCode").val(),false,stockId,addRow);
			jQuery("#ornaBarCode").val("");
		}
	});
	jQuery("#btnToList").click(function(){
		window.location = "outBack.vm?user_action=toOutBackList";
	});
	 resetSum();
  	new Calendar({
      inputField: "doDate",
      dateFormat: "%Y-%m-%d",
      trigger: "doDate",
      bottomBar: true,
      showTime:false,
      value:new Date(),
      onSelect: function() {
        this.hide();
      }
    });
	checkReview();
		DictDwr.getDictsForSlt("invcode", function(data){
    		addOptions("stockId", data, null, null, true, true, "$!{outBack.stockId}");
    	});
})
function exportListToExcel(){
	jQuery("#user_action").val("baseExportExcelLine");
	jQuery("#frm").submit();
	jQuery("#user_action").val("toEdit");
}

</script>