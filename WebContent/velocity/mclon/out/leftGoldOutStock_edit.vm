#set($jsfiles = ["$StringUtil.getContextPath()/js/out/outStock.js",
"$StringUtil.getContextPath()/dwr/interface/OutStockDwr.js",
"$StringUtil.getContextPath()/script/mclon/calendar/calendar.js"])
#set($cssfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.css"])
	
	
<form id='frm' action="leftGoldOutStock.vm" method="post">
	#set($outStock = $form.head)
	#set($enableSave = true)
	#set($enableAudit = true)
	#set($enableInvaid = false)
	#set($enableClose = false)
	#set($modelCode = '08040902')
	#if($StringUtil.isNotBlank($outStock.status))
		#if("$!StringUtil.getOrgId($session)" == "$!outStock.orgId")
    		#if($outStock.status == "1")
    			#set($enableAudit = true)
    			#set($enableSave = true)
    		#elseif($outStock.status == "5")##审批完成
            	#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = false)
            	#set($enableClose = true)
    		#elseif($outStock.status == "8")##关闭状态
    			#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = true)
            	#set($enableClose = false)
    		#else
    			#set($enableSave = false)
            	#set($enableAudit = false)
            	#set($enableInvaid = false)
            	#set($enableClose = false)
			#end
		#else
			#set($enableSave = false)
        	#set($enableAudit = false)
		#end
	#end
	<input type="hidden" id="user_action" name="user_action" value=""/>
	<input type="hidden" id="billid" name="billid" value="$!{outStock.billid}"/>
    <table class="title">
    	<tr><td>余金领用详细页</td></tr>
    </table>
    <table class="control">
    	<tr><td>
				<input type='button' value='保存' #if(!$enableSave)disabled#end class='btn' id='btnSave' onclick="saveform('4','leftGold','save')" $RightUtil.able($session, $modelCode,'1')>
				<input type='button' value='审核' #if(!$enableAudit)disabled#end class='btn' id='btnCheck' onclick="saveform('4','leftGold','audit')" $RightUtil.able($session, $modelCode,'2')>
				<input type='button' value='关闭' #if(!$enableClose)disabled#end class='btn' id='btnClose' onclick="changeState($outStock.billid,'close','确认关闭此单据')" $RightUtil.able($session, $modelCode,'3')>
				<input type='button' value='打印' class='btn' id='btnPrint' onclick="window.print()" $RightUtil.able($session, $modelCode,'4')>
				<input type='button' value='作废' #if(!$enableInvaid)disabled#end class='btn' id='btnInvalid' onclick="changeState($outStock.billid,'invalid','确认作废此单据')" $RightUtil.able($session, $modelCode,'5')>
				<input type='button' value='Excel' class='btn' id='exportToExcel' onclick="exportListToExcel()">
				<input type='button' value='返回列表' class='btn' id="btnToList">
		</td></tr>
    </table>
    <table class='content'>
		#if($StringUtil.isEmpty($outStock.billid))
			#set($dodate = $DateUtil.getCurrentDate10())
			#set($billno = "自动生成")
			#set($state = "保存")
			#set($orgId = $StringUtil.getOrgId($session))
		#else
			#set($dodate = $outStock.dodate)
			#set($billno = $outStock.billno)
			#set($state = $!DictUtil.getValue('status', $!outStock.status))
		#end
    	<tr>
			<td class='body1'>单据编号：</td>
			<td class='body2'>
				<input type='text' id="billno" name='billno' readonly value="$!billno">
			</td>
			<td class='body1'>单据日期：</td>
			<td class='body2'>
				<input type='text' id="dodate" name='dodate' readonly value="$!dodate" dataType="Require" msg="不能为空">
				$StringUtil.star()
			</td>
			<td class='body1'>库存组织:</td>	
			<td class='body2'>
				<input type='hidden' id="orgId" name='orgId' value="$!{outStock.orgId}">
				<input type='text' id="orgName" name='orgName'  value="$!BdCommon.getOrgName($outStock.orgId)" readonly  dataType="Require" msg="不能为空">
				$StringUtil.star()
			</td>
			<td class='body1'>单据状态：</td>	
			<td class='body2'>
				<input type='hidden' id="status" name='status' value="$!{outStock.status}">
				<input type='text' id="statusName" name='statusName' readonly value="$!state">
			</td>
		</tr>
		<tr>
			<td class='body1'>件数合计：</td>	
			<td class='body2'>
				<input type='text' id="sumCount" name='sumCount' readonly value="$!{outStock.sumCount}">
			</td>
			<td class='body1'>重量合计：</td>	
			<td class='body2'>
				<input type='text' id="sumWeight" readonly name='sumWeight' value="$!{outStock.sumWeight}">
			</td>
			<td class='body1'>粒数合计：</td>
			<td class='body2'>
				<input type='text' id="sumGrains" readonly name='sumGrains' value="$!{outStock.sumGrains}">
			</td>
			<td class='body1'>金额合计：</td>
			<td class='body2'>
				<input type='hidden' id="sumCost" name='sumCost' value="$!{outStock.sumCost}">
				<input type='text' id="sumMoney" name='sumMoney' readonly value="$!{outStock.sumMoney}">
			</td>
		</tr>
		<tr>
			<td class='body1'>饰品条码：</td>
			<td class='body2'>
				<input type='text' id="ornaBarCode" name='ornaBarCode' value="">
			</td>
			<td class='body1'>饰品编码：</td>
			<td class='body2'>
				<input type='text' id="ornaCode" name='ornaCode'  value="">
			</td>
			<td class='body1'>仓库</td><td class='body2'>
				<select id='stockId' name='stockId' dataType="Require" msg="不能为空"></select>$StringUtil.star()
			</td>
		</tr>
        
		<tr>
			<td class='body1'>备注：</td>
			<td class='body2' colspan="3">
				<input type="text" id="memo" name="memo" style="width:90%;" value="$!{outStock.memo}"/>
			</td>
		</tr>
    </table>
	<div class="scroll2">
	    <table class='list' style="width:1100px;">
    	<thead>
			<tr>
				<th width='35px'>行号</th>
				<th width='90px'>大类</th>
				<th width='90px'>小类</th>
				<th width='90px'>款式</th>
                <th width='90px'>分析范围</th>
        		<th width='90px'>饰品编码</th>
        		<th width='120px'>饰品名称</th>
				<th width='60px'>计量单位</th>
				<th width='60px'>现有量</th>
				<th width='60px'>总重量</th>
				<th width='60px'>粒数</th>
				<th width='60px'>销售金额</th>
				<th width='60px'>主石重量</th>
        		<th width='60px'>配石重量</th>
				#if(!$StringUtil.isNotBlank($outStock.status)||$StringUtil.isNotBlank($outStock.status)&&$outStock.status == "1")
					<th width='60px'></th>
				#end
            </tr>
        </thead>
        <tbody id="tbl">
		#foreach($map in $form.list)
			<tr>
				<td>$velocityCounter</td>
				<td>$!BdCommon.getItemClassDesc($map.itemClassId)</td>
				<td>$!BdCommon.getOrnaClassDesc($map.ornaClassId)</td>
				<td>$!HtmlUtil.printStyle($!map.styleId, $!map.styleName, $!map.bigGraph)</td>
				<td>$!map.alaysisCode</td>
                <td>$!map.ornaCode</td>
                <td>$!map.ornaDsc</td>
				<td>$!BdCommon.getUnitName($map.unitId)</td>
				<td>$!StringUtil.formatDouble($!map.nowQty,2)</td>
				<td>$!StringUtil.formatDouble($!map.allQty,2)</td>
				<td>$!map.grains</td>
				<td>$!map.posMoney</td>
				<td>$!map.mainWeight</td>
				<td>$!map.partWeight</td>
				<td>
				<input type='hidden' name="#lineid" value="$!map.lineid">
				<input type='hidden' name="#itemClassId"  value="$!map.itemClassId">
				<input type='hidden' name="#ornaClassId"  value="$!map.ornaClassId">
				<input type='hidden' name="#styleId"  value="$!map.styleId">
				<input type='hidden' name="#alaysisId"  value="$!map.alaysisId">
				<input type='hidden' name="#ornaCode"  value="$!map.ornaCode">
				<input type='hidden' name="#ornaBarCode"  value="$!map.ornaBarCode">
				<input type='hidden' name="#ornaDsc"  value="$!map.ornaDsc">
				<input type='hidden' name="#unitId"  value="$!map.unitId">
				<input type='hidden' name="#nowQty"  value="$!map.nowQty">
				<input type='hidden' name="#allQty"  value="$!map.allQty">
				<input type='hidden' name="#grains"  value="$!map.grains">
				<input type='hidden' name="#mainWeight"  value="$!map.mainWeight">
				<input type='hidden' name="#partWeight"  value="$!map.partWeight">
				<input type='hidden' name="#isMutiPart"  value="$!map.isMutiPart">
				<input type='hidden' name="#isDblLabel"  value="$!map.isDblLabel">
				<input type='hidden' name="#isPsale"  value="$!map.isPsale">
				<input type='hidden' name="#posCost"  value="$!map.posCost">
				<input type='hidden' name="#posMoney"  value="$!map.posMoney">
				<input type='hidden' name="#styleOrnaClass"  value="$!map.styleOrnaClass">
				<input type='hidden' name="#styleItemClass"  value="$!map.styleItemClass">
				<input type='hidden' name="#styleMiddleClass"  value="$!map.styleMiddleClass">
				#if(!$StringUtil.isNotBlank($outStock.status)||$StringUtil.isNotBlank($outStock.status)&&$outStock.status == "1")
					<input type='button' class='btn' value='删除' onclick="deleteLine(this,$!map.lineid)">
				#end
				</td>
			</tr>
		#end
    	</tbody>
    </table>
	</div>
</form>
<script>

jQuery(function(){
	checkTable('tbl');
	changeSeq("tbl");
	setEnterKey("ornaCode",function(){
	    var stockId=jQuery("#stockId").val();
		if(!stockId){
    		alert("请选择仓库");
			jQuery("#ornaCode").val("");
    		return;
		}
		var code=jQuery("#ornaCode").val();
		if(code){
			if(checkOrnaCode(code)){
				alert("此饰品编码已经存在,请重新输入!")
			}else
				OutStockDwr.getOrnaInfo(jQuery("#orgId").val(),jQuery("#ornaCode").val(),true,stockId,addRow);
			jQuery("#ornaCode").val("");
		}
	});
	setEnterKey("ornaBarCode",function(){
       var stockId=jQuery("#stockId").val();
		if(!stockId){
    		alert("请选择仓库");
			jQuery("#ornaBarCode").val("");
    		return;
		}
		var barCode=jQuery("#ornaBarCode").val();
		if(barCode){
			if(checkOrnaCode(barCode,true)){
				alert("此饰品条码已经存在,请重新扫描!")
			}else
				OutStockDwr.getOrnaInfo(jQuery("#orgId").val(),jQuery("#ornaBarCode").val(),false,stockId,addRow);
			jQuery("#ornaBarCode").val("");
		}
	});
	jQuery("#btnToList").click(function(){
		window.location = "leftGoldOutStock.vm?user_action=toList";
	});
	 resetSum();
	  new Calendar({
      inputField: "dodate",
      dateFormat: "%Y-%m-%d",
      trigger: "dodate",
      bottomBar: true,
      showTime:false,
      value:new Date(),
      onSelect: function() {
        this.hide();
      }
    });
	checkReview();
	DictDwr.getDictsForSlt("invcode", function(data){
    		addOptions("stockId", data, null, null, true, true, "$!{outStock.stockId}");
    	});
})

function exportListToExcel(){
	jQuery("#user_action").val("exportExcelLine");
	jQuery("#frm").submit();
	jQuery("#user_action").val("toEdit");
}
</script>