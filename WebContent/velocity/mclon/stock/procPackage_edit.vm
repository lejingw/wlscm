#set($cssfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.css"])
#set($jsfiles = ["$StringUtil.getContextPath()/script/mclon/calendar/calendar.js",
                "$StringUtil.getContextPath()/dwr/interface/PackageDwr.js?t=201203201339.js", 
                "$StringUtil.getContextPath()/js/stock/package.js?t=201203311026.js",
				"$StringUtil.getContextPath()/script/mclon/ZeroClipboard/ZeroClipboard.js"])
	
<form id='frm' action="procPackage.vm" method="post">
	#set($procPackage = $form.procPackageHead)
	#set($oldLines = $form.oldLines)
	#set($newLines = $form.newLines)
	
	#set($status = $procPackage.status)
	#set($enableAdd = false)
	#set($enableSave = false)
	#set($enableClose = false)
	#set($enablePrintLabel = false)
	
	#set($isSaved = false)
	
	#if($StringUtil.isBlank($!procPackage.billno))
		#set($billno = "自动生成")
		#set($orgId = $StringUtil.getOrgId($session))
		#set($dodate = $DateUtil.getCurrentDate10())
		#set($status = "1")
	#else
		#set($billno = $procPackage.billno)
		#set($orgId = $procPackage.orgId)
		#set($dodate = $procPackage.dodate)
		#set($status = $procPackage.status)
	#end
		
	#if($StringUtil.isNotBlank($status))
		#if($status == "1")
			#set($enableAdd = true)
			#set($enableSave = true)
			#set($isSaved = true)
			#set($enableClose = true)
		#elseif($status == "8")##关闭
			#set($enablePrintLabel = true)
		#end
	#end
	
	#if($status == "5")
		#set($enableClose = true)
	#end
	
	<input type="hidden" id="user_action" name="user_action" value=""/>
	<input type="hidden" id="billid" name="billid" value="$!{procPackage.billid}"/>
    <table class="title">
    	<tr><td>拆混包详细页</td></tr>
    </table>
    <table class="control">
    	<tr><td>
				<input type='button' value='增行' #if(!$enableAdd)disabled#end class='btn' id='btnAddNewMater' $RightUtil.able($session, '08030302','1')>
				<input type='button' value='保存' #if(!$enableSave)disabled#end class='btn' id='btnSave' $RightUtil.able($session, '08030302','2')>
				<input type='button' value='记账' #if(!$enableClose)disabled#end class='btn' id='btnCheck' $RightUtil.able($session, '08030302','3')>
				<input type='button' value='返回列表' class='btn' id="btnToList">
				<input type='button' value='打印标签' #if(!$enablePrintLabel)disabled#end class='btn' id='btnPrintLabel' $RightUtil.able($session, '08030302','4')>
				<input type='button' value='打印' class='btn' id='btnPrint' onclick="window.print()" $RightUtil.able($session, '08030302','5')>
						
		</td></tr>
    </table>
    <table class='content'>
		
    	<tr>
			<td class='body1'>单据编号：</td>
			<td class='body2'>
				<input type='text' id="billno" name='billno' readonly value="$!billno">
			</td>
			<td class='body1'>单据日期：</td>
			<td class='body2'>
				<input type='text' id="dodate" name='dodate' readonly #if(!$isSaved)disabled#end value="$!{dodate}" dataType="Require" msg="不能为空">
			</td>
			<td class='body1'>组织:</td>	
			<td class='body2'>
				<input type='hidden' id="orgId" name='orgId' value="$!{orgId}">
				<input type='text' id="orgName" name='orgName'  value="$!BdCommon.getOrgName($orgId)" readonly  dataType="Require" msg="不能为空" >
			</td>
			<td class='body1'>单据状态：</td>	
			<td class='body2'>
				<input type='hidden' id="status" name='status' readonly value="$!{status}">
				<input type='text' id="statusName" name='statusName' readonly value="$!DictUtil.getValue('status', $!{status})">
			</td>
		</tr>
		<tr>
			<td class='body1'>原重量合计：</td>	
			<td class='body2'>
				<input type='text' id="oldWeight" readonly name='oldWeight' value="$!{procPackage.oldWeight}">
			</td>
			<td class='body1'>原粒数合计：</td>
			<td class='body2'>
				<input type='text' id="oldGrains" readonly name='oldGrains' value="$!{procPackage.oldGrains}">
			</td>
			<td class='body1'>新重量合计：</td>	
			<td class='body2'>
				<input type='text' id="newWeight" name='newWeight' readonly value="$!{procPackage.newWeight}">
			</td>
			<td class='body1'>新粒数合计：</td>
			<td class='body2'>
				<input type='text' id="newGrains" name='newGrains' readonly value="$!{procPackage.newGrains}">
			</td>
		</tr>
		<tr>
			<td class='body1'>业务类型：</td>	
			<td class='body2'>
				<select id="dotype" name="dotype" #if($procPackage)disabled#end  dataType="Require" value="$procPackage.dotype" msg="不能为空">$StringUtil.emptyOption()</select>
				$StringUtil.star()
			</td>
			<td class='body1'>仓库：</td>
			<td class='body2'>
				<select id="stock_id" name="stock_id" #if($procPackage)disabled#end  dataType="Require" value="$procPackage.stockId" msg="不能为空" >
					$StringUtil.emptyOption()
				</select>
				$StringUtil.star()
			</td>
			<td class='body1'>备注：</td>
			<td class='body2' colspan="3">
				<input type="text" id="memo" name="memo" #if(!$!isSaved)readonly#end style="width:90%;" value="$!{procPackage.memo}"/>
			</td>
		</tr>
		<tr>
			<td class='body1'>条码：</td>
			<td class='body2'>
				<input type='text' id="barCode_in" name='barCode_in' #if(!$!isSaved)disabled#end value="">
			</td>
			<td class='body1'>编码：</td>
			<td class='body2'>
				<input type='text' id="ornaCode_in" name='ornaCode_in' #if(!$!isSaved)disabled#end  value="">
			</td>
			<td class='body2' colspan="4"></td>
		</tr>
    </table>
	<input type='hidden' id="deleteOldIds" name='deleteOldIds'  value=""/>
	<input type='hidden' id="deleteNewIds" name='deleteNewIds'  value=""/>
	<input type='hidden' id="needChecked" name='needChecked'  value=""/>
	
	<div style="background-color: #EBEBEB;font-weight: bold;">&nbsp;&nbsp;原饰品标签</div>
	<table class='list'>
    	<thead>
			<tr>
				<th></th>
				<th>大类</th>
				<th>小类</th>
				<th>款式</th>
                <th>分析范围</th>
        		<th>饰品编码</th>
        		<th>饰品名称</th>
				<th>计量单位</th>
				<th>现有量</th>
				<th>总重量</th>
				<th>粒数</th>
				<th>销售金额</th>
				<th>主石重量</th>
        		<th>配石重量</th>
                <th>主石形状</th>
				<th>主石颜色</th>
				<th>新值</th>
				<th width='60px'></th>
            </tr>
        </thead>
        <tbody id="tbl_old_mater">
		#foreach($oldLine in $oldLines)
			<tr>
				<td></td>
				<td>$!oldLine.itemClassName</td>
				<td>$!oldLine.ornaClassName</td>
				<td>$!HtmlUtil.printStyle($!oldLine.styleId, $!oldLine.styleName, $!oldLine.bigGraph)</td>
				<td>$!oldLine.alaysisName</td>
				<td>$!oldLine.ornaCode</td>
				<td>$!oldLine.ornaDsc</td>
				<td>$!oldLine.unitName</td>
                <td>$!oldLine.nowQty</td>
				<td>$!oldLine.allQty</td>
				<td>$!oldLine.grains</td>
				<td>$!oldLine.posMoney</td>
				<td>$!oldLine.mainWeight</td>
				<td>$!oldLine.partWeight</td>
				<td>$!oldLine.mainShapeName</td>
				<td>$!oldLine.colorName</td>
				<td><input type='checkbox' name='newVal' #if("$!oldLine.newVal" == "1")checked#end #if(!$!isSaved)disabled#end onclick="checkNewVal(this)" style='width:10px;'/></td>
				<td><input type='button' value='删除' #if(!$!isSaved)disabled#end style='width:60px;' onclick='deleteMater(this, "$!{oldLine.ornaCode}")'/>
    				<input type='hidden' name='itemClassId' value="$!oldLine.itemClassId" />
    				<input type='hidden' name='ornaClassId' value="$!oldLine.ornaClassId" />
    				<input type='hidden' name='styleId' value="$!oldLine.styleId" /> 
    				<input type='hidden' name='alaysisId' value="$!oldLine.alaysisId" />
    				<input type='hidden' name='alaysisName' value="$!oldLine.alaysisName" />
    				<input type='hidden' name='ornaCode' value="$!oldLine.ornaCode" /> 
    				<input type='hidden' name='ornaDsc' value="$!oldLine.ornaDsc" /> 
    				<input type='hidden' name='ornaBarcode' value="$!oldLine.ornaBarcode" />
    				<input type='hidden' name='saleUnitId' value="$!oldLine.unitId" /> 
    				<input type='hidden' name='nowQty' value="$!oldLine.nowQty" /> 
    				<input type='hidden' name='allQty' value="$!oldLine.allQty" /> 
    				<input type='hidden' name='stoneNowNum' value="$!oldLine.grains" />
    				<input type='hidden' name='posAmount' value="$!oldLine.posMoney" /> 
    				<input type='hidden' name='mainWeight' value="$!oldLine.mainWeight" /> 
    				<input type='hidden' name='partWeight' value="$!oldLine.partWeight" />
    				<input type='hidden' name='isMutiPart' value="$!oldLine.isMutiPart" />
    				<input type='hidden' name='isDblLabel' value="$!oldLine.isDblLabel" />
    				<input type='hidden' name='isConsign' value="$!oldLine.isPsale" />
					<input type='hidden' name='stockId' value="$!oldLine.stockId" />
					<input type='hidden' name='realTotalCost' value="$!oldLine.posCost" />
					<input type='hidden' name='inivCost' value="$!oldLine.inivCost" />
					<input type='hidden' name='mainShapeId' value="$!oldLine.mainShapeId" />
					<input type='hidden' name='colorId' value="$!oldLine.colorId" />
    				<input type='hidden' name='oldLineid' value="$!oldLine.lineid" />					
				</td>
			</tr>
		#end
    	</tbody>
    </table>
	<br>
	<div style="background-color: #EBEBEB;font-weight: bold;">&nbsp;&nbsp;新饰品标签</div>
	<table class='list'>
    	<thead>
			<tr>
				<th></th>
                <th>新编码</th>
				<th>粒数</th>
				<th>重量</th>
				<th>分析范围</th>
				<th>磅差</th>
				<th width='60px'></th>
            </tr>
        </thead>
        <tbody id="tbl">
		#foreach($newLine in $newLines)
			<tr>
				<td></td>
                <td><input type='hidden' name='newLineId' value="$!newLine.lineid"/>
					<input type='hidden' name='newBarCode' value="$!newLine.ornaBarcode"/>
					<input type='hidden' name='newInivCost' value="$!newLine.inivCost"/>
					<input type='text' name='newCode' value="$!newLine.ornaCode" readonly />
				</td>
				<td>
					#if($procPackage.dotype == "2")
					<input type='hidden' name='newStoneNum' disabled />
					#else
					<input type='text' name='newStoneNum' value="$!newLine.grains" #if(!$!isSaved)readonly#end dataType='Require' onblur='checkField(this)' msg='不能为空'/>
					<font color='red'>*</font>
					#end
                </td>
				<td>
					<input type='text' name='new_Weight' value="$!newLine.allQty" #if(!$!isSaved)readonly#end dataType='Require' onblur='checkField(this)' msg='不能为空'/>
					<font color='red'>*</font>
                </td>
				<td>
    				<input type='hidden' name='newAlaysisId' value="$!newLine.analysisArangeId"/>
    				<input type='text' name='newAlaysisName' value="$!newLine.analysisArangeName" dataType='Require' readonly msg='不能为空'/>
					<font color='red'>*</font>
                </td>
				<td style="color:red;">#if("$!newLine.poundsDiff" == "1")是#end</td>
				<td>
					<input type='button' #if(!$!isSaved)disabled#end value='删除' style='width:60px;' onclick="deleteNewMater(this,'tbl')"/>
                </td>
			</tr>
		#end
    	</tbody>
    </table>
</form>
<script>

//业务类型
function setPackageType(ptype){
	DictDwr.getDictsForSlt('packagetype', function(data){
		addOptions("dotype", data, null, null, true, true, ptype);
	});
}

// 手工输入饰品编码出发的方法
function loadOldItemByOrnaCode(){
	if(!loadBefore()) return ;
	var ornaCode = jQuery("#ornaCode_in").val(),
		stockId = jQuery("#stock_id").val();
	if(ornaCode){
		PackageDwr.getMaterActiveByOrnaCode(ornaCode, jQuery("#orgId").val(), stockId, jQuery("#dotype").val(), function(data){
    		if (data) {
        		addPackageOldMaterActive(data);
        	} else {
        		alert("饰品不存在或不属于该组织");
        	}
    	})
    	jQuery("#ornaCode_in").val("");
	}
}
// 扫描枪 扫描饰品出发的方法
function loadOldItemByBarCode(){
	if(!loadBefore()) return ;
	var barCode = jQuery("#barCode_in").val(),
		stockId = jQuery("#stock_id").val();
	if(barCode){
		PackageDwr.getMaterActiveByBarCode(barCode, jQuery("#orgId").val(), stockId, jQuery("#dotype").val(), function(data){
    		if (data) {
        		addPackageOldMaterActive(data);
        	} else {
        		alert("饰品不存在或不属于该组织");
        	}
    	})
    	jQuery("#barCode_in").val("");	
	}
}

function loadBefore(){
	var stockId = jQuery("#stock_id").val(),
		dotype = jQuery("#dotype").val();
	if(!dotype){
		alert("请选择业务类型");
		return false;
	}
	if(!stockId){
		alert("请先选择仓库");
		return false;
	}
	return true;
}
jQuery(function(){
	initCalendar("dodate");
	jQuery("#deleteNewIds").val("");
	jQuery("#deleteOldIds").val("");
	jQuery("#needChecked").val("");
	setEnterKey("ornaCode_in", loadOldItemByOrnaCode);	
	setEnterKey("barCode_in", loadOldItemByBarCode);	
	//jQuery("#barCode_in").change(loadOldItemByBarCode);
	jQuery("#btnAddNewMater").click(addRow);
	DictDwr.getDictsForSlt("invcode", function(data){
		addOptions("stock_id",  data, null, null, true, true, "$!procPackage.stockId");
	});
	setPackageType("$procPackage.dotype"); // 设置业务类型值
	
	jQuery("#btnSave").click(saveform);
	jQuery("#btnCheck").click(saveAndClose);
	//jQuery("#btnPrintLabel").click(printLabel);
	initLabelPrint("btnPrintLabel", printLabel);
	jQuery("#btnToList").click(function(){
		window.location = "procPackage.vm";
	});
	checkReview();
	changeSeq("tbl");
	changeSeq("tbl_old_mater");
})

</script>